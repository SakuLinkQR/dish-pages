<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>QRã‚¯ã‚¨ã‚¹ãƒˆ - ã‚¹ã‚­ãƒ£ãƒŠãƒ¼</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <style>
    body {
      font-family: sans-serif;
      background-color: #fefefe;
      text-align: center;
      padding: 10px;
      margin: 0;
      overflow-x: hidden;
    }

    h1 {
      color: #007bff;
      font-size: 1.6rem;
      margin-bottom: 12px;
      line-height: 1.4;
    }

    #preview {
      width: 300px;
      height: 300px;
      border: 1px solid #ccc;
      margin: 20px auto;
      background: black;
      position: relative;
    }

    #preview video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    #status {
      color: gray;
      font-size: 0.9rem;
      margin: 6px 0;
    }

    #result {
      font-size: 1rem;
      color: #d32f2f;
      margin: 6px 0 14px;
      min-height: 1.2em;
    }

    .btn {
      margin: 6px;
      padding: 10px 20px;
      background-color: #4caf50;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      cursor: pointer;
    }

    .btn-exit {
      background-color: #ff7043;
    }
  </style>
</head>
<body>

  <h1>ğŸ¯ QRã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿å–ã£ã¦<br>ã‚¯ã‚¨ã‚¹ãƒˆã‚’é€²ã‚ã‚ˆã†</h1>
  <div id="preview"></div>
  <p id="status">ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ä¸­â€¦</p>
  <div id="result"></div>

  <button onclick="rescan()" class="btn">ğŸ”„ å†ã‚¹ã‚­ãƒ£ãƒ³</button>
  <button onclick="exitToMenu()" class="btn btn-exit">ğŸ  ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹</button>

  <!-- html5-qrcode æœ¬ä½“ -->
  <script src="https://unpkg.com/html5-qrcode"></script>
  <script>
    const html5QrCode = new Html5Qrcode("preview");
    const statusText = document.getElementById("status");
    const resultContainer = document.getElementById("result");

    // åŒä¸€ã‚³ãƒ¼ãƒ‰ã®é€£ç¶šåˆ¤å®šã‚’æŠ‘åˆ¶ã™ã‚‹ãŸã‚ã®ãƒ‡ãƒã‚¦ãƒ³ã‚¹
    let lastText = "";
    let lastAt = 0;

    // é·ç§»æ™‚ã®å¤šé‡ã‚¹ã‚¿ãƒ¼ãƒˆé˜²æ­¢ãƒ•ãƒ©ã‚°
    let hasRedirected = false;

    // ã‚«ãƒ¡ãƒ©é–‹å§‹ï¼ˆå…±é€šï¼‰
    async function startScanner() {
      try {
        await html5QrCode.start(
          { facingMode: "environment" },
          { fps: 10, qrbox: 250 },
          onScanSuccess,
          onScanFailure
        );
        statusText.innerText = "ã‚«ãƒ¡ãƒ©ãŒèµ·å‹•ã—ã¾ã—ãŸã€‚QRã‚³ãƒ¼ãƒ‰ã‚’ã‹ã–ã—ã¦ãã ã•ã„ã€‚";
      } catch (err) {
        statusText.innerText = "ã‚«ãƒ¡ãƒ©ã‚¨ãƒ©ãƒ¼ï¼š" + err;
      }
    }

    // ã‚«ãƒ¡ãƒ©åœæ­¢ï¼ˆå…±é€šï¼‰
    async function stopScanner() {
      try {
        if (html5QrCode._isScanning) {
          await html5QrCode.stop();
        }
      } catch (_) {
        // å¤±æ•—ã¯æ¡ã‚Šã¤ã¶ã—
      } finally {
        document.getElementById("preview").innerHTML = "";
      }
    }

    // ã‚¹ã‚­ãƒ£ãƒ³æˆåŠŸæ™‚
    function onScanSuccess(decodedText) {
      if (hasRedirected) return;

      // â–¼åŒä¸€å†…å®¹ã®é€£ç¶šãƒ’ãƒƒãƒˆã¯1.5ç§’ç„¡è¦–ï¼ˆæ‰‹ãƒ–ãƒ¬ã‚„é€£ç¶šæ¤œå‡ºå¯¾ç­–ï¼‰
      const now = Date.now();
      if (decodedText === lastText && now - lastAt < 1500) return;
      lastText = decodedText;
      lastAt = now;

      // URLä»¥å¤–ã¯ç„¡åŠ¹ã¨ã—ã¦å³ãƒªã‚¿ãƒ¼ãƒ³ï¼ˆã‚«ãƒ¡ãƒ©ã¯æ­¢ã‚ãªã„ï¼‰
      if (!decodedText.startsWith("http")) {
        resultContainer.innerText = "ç„¡åŠ¹ãªQRã‚³ãƒ¼ãƒ‰ã§ã™ã€‚ã‚‚ã†ä¸€åº¦ã‹ã–ã—ã¦ãã ã•ã„ã€‚";
        statusText.innerText = "æ­£ã—ã„QRã‚’ã‚‚ã†ä¸€åº¦ã‹ã–ã—ã¦ãã ã•ã„ã€‚";
        navigator.vibrate?.(80);
        return;
      }

      // URLãƒ‘ãƒ¼ã‚¹ã¨ãƒ›ãƒ¯ã‚¤ãƒˆãƒªã‚¹ãƒˆåˆ¤å®š
      try {
        const url = new URL(decodedText);
        const domain = url.hostname;
        const path = url.pathname;

        const allowed =
          domain === "sakulink.com" &&
          (
            // ãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—
            path === "/qr-quest/progress.html" ||
            path === "/qr-quest/result.html" ||

            // ã‚¤ãƒ™ãƒ³ãƒˆç‰ˆï¼ˆ/qr-quest/events/<event>/...ï¼‰
            /^\/qr-quest\/events\/[^\/]+\/(progress|result)\.html$/.test(path)
          );

        if (allowed) {
          hasRedirected = true;
          // ç”»é¢é·ç§»å‰ã«åœæ­¢ï¼ˆã‚«ãƒ¡ãƒ©ãƒªã‚½ãƒ¼ã‚¹è§£æ”¾ï¼‰
          stopScanner().finally(() => {
            window.location.href = decodedText;
          });
        } else {
          resultContainer.innerText = "ã“ã‚Œã¯å…¬å¼QRã‚¯ã‚¨ã‚¹ãƒˆç”¨ã‚³ãƒ¼ãƒ‰ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚";
          statusText.innerText = "æ­£ã—ã„QRã‚’ã‚‚ã†ä¸€åº¦ã‹ã–ã—ã¦ãã ã•ã„ã€‚";
          navigator.vibrate?.(80);
          return; // ã‚«ãƒ¡ãƒ©ç¶™ç¶š
        }
      } catch {
        resultContainer.innerText = "èª­ã¿å–ã‚Šã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ã©ã†ãã€‚";
        statusText.innerText = "æ­£ã—ã„QRã‚’ã‚‚ã†ä¸€åº¦ã‹ã–ã—ã¦ãã ã•ã„ã€‚";
        return; // ã‚«ãƒ¡ãƒ©ç¶™ç¶š
      }
    }

    // ã‚¹ã‚­ãƒ£ãƒ³å¤±æ•—æ™‚ï¼ˆãƒ•ãƒ¬ãƒ¼ãƒ æ¯ã®å¤±æ•—é€šçŸ¥ã€‚ç‰¹ã«ä½•ã‚‚ã—ãªã„ï¼‰
    function onScanFailure(_) { /* no-op */ }

    // å†ã‚¹ã‚­ãƒ£ãƒ³
    async function rescan() {
      hasRedirected = false;
      resultContainer.innerText = "";
      statusText.innerText = "å†ã‚¹ã‚­ãƒ£ãƒ³ã‚’æº–å‚™ä¸­â€¦";

      await stopScanner();
      setTimeout(startScanner, 300);
    }

    // âœ… ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹ï¼šQuestãƒ¡ãƒ‹ãƒ¥ãƒ¼ã§ã¯ãªãã€Œå…¬å¼ãƒ›ãƒ¼ãƒ (index)ã€ã¸æˆ»ã™
    async function exitToMenu() {
      await stopScanner();
      window.location.href = "../index.html";
    }

    // ãƒšãƒ¼ã‚¸å¯è¦–çŠ¶æ…‹ã®å¤‰åŒ–ã§å†èµ·å‹•ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶æˆ»ã‚‹ç­‰ã§å¾©å¸°æ™‚ã«å›ºã¾ã‚‹å¯¾ç­–ï¼‰
    document.addEventListener("visibilitychange", () => {
      if (document.visibilityState === "visible" && !hasRedirected) {
        startScanner();
      }
    });

    // ãƒšãƒ¼ã‚¸é·ç§»/ç ´æ£„æ™‚ã¯æ˜ç¤ºåœæ­¢ï¼ˆã‚«ãƒ¡ãƒ©ã‚’æ´ã¿ã£ã±ãªã—ã«ã—ãªã„ï¼‰
    window.addEventListener("pagehide", stopScanner);
    window.addEventListener("beforeunload", stopScanner);

    // åˆå›èµ·å‹•
    startScanner();
  </script>
</body>
</html>

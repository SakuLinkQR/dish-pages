<!DOCTYPE html>
<html lang="ja">
<head>
  <script src="event-config.js"></script>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ãŠå®é€²è¡ŒçŠ¶æ³</title>
  <style>
    body {
      font-family: system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",sans-serif;
      text-align: center;
      padding: 26px 10px;
      background-color: #fffaf2;
    }

    h1 {
      font-size: 1.5rem;
      color: #4b2e0d;
      margin: 0 0 10px;
      line-height: 1.3;
    }

    .sub {
      font-size: 0.95rem;
      color: #6b4a2a;
      margin: 0 0 18px;
    }

    .grid {
      display: grid;
      gap: 0;
      margin: 0 auto;
      border-radius: 12px;
      overflow: hidden;
      background: #fff;
      box-shadow: 0 10px 24px rgba(0,0,0,.08);
    }

    .grid img {
      width: 100%;
      height: 100%;
      display: block;
      padding: 0;
      margin: 0;
      border: none;
      background: transparent;
      object-fit: cover;
    }

    .btn {
      margin-top: 20px;
      padding: 12px 22px;
      font-size: 1rem;
      background-color: #4fa3ff;
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 800;
    }

    .btn-reward {
      margin-top: 14px;
      padding: 12px 22px;
      font-size: 1rem;
      background-color: #ffcc00;
      color: #000;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 900;
    }

    .btn-sub {
      background-color: #ffffff;
      color: #1e88e5;
      border: 2px solid #1e88e5;
      margin-top: 14px;
    }

    .row {
      display: flex;
      gap: 10px;
      justify-content: center;
      flex-wrap: wrap;
      margin-top: 18px;
    }

    .row .btn {
      margin-top: 0;
      min-width: 220px;
    }
  </style>

  <script>
    // å—ä»˜ã‚¹ã‚¿ãƒ¼ãƒˆå¿…é ˆ
    const started = (localStorage.getItem('started') === 'true');
    if (!started) {
      location.replace('need_start.html');
      throw new Error('not started');
    }

    // åˆæœŸãƒ”ãƒ¼ã‚¹ï¼ˆ1ã¨5ï¼‰ã‚’ç¢ºå®Ÿã«ã‚»ãƒƒãƒˆï¼ˆå—ä»˜ã‚¹ã‚¿ãƒ¼ãƒˆå¾Œã«åæ˜ ã•ã‚Œãªã„ã‚±ãƒ¼ã‚¹å¯¾ç­–ï¼‰
    try {
      const started = (localStorage.getItem('started') === 'true');
      const has1 = (localStorage.getItem('q_piece1') === 'true' || localStorage.getItem('piece1') === 'true' || localStorage.getItem('qrquest_piece1') === 'true');
      const has5 = (localStorage.getItem('q_piece5') === 'true' || localStorage.getItem('piece5') === 'true' || localStorage.getItem('qrquest_piece5') === 'true');
      const seeded = (localStorage.getItem('seeded_1_5') === 'true');
      if (started && !seeded && (!has1 || !has5)) {
        localStorage.setItem('q_piece1','true');
        localStorage.setItem('q_piece5','true');
        localStorage.setItem('piece1','true');
        localStorage.setItem('piece5','true');
        localStorage.setItem('qrquest_piece1','true');
        localStorage.setItem('qrquest_piece5','true');
        localStorage.setItem('seeded_1_5','true');
      }
    } catch(e) {}


    // 9åˆ†å‰²ï¼ˆq_piece1..9ï¼‰
    const total = 9;
    const cols = 3;
    const cell = 110;

    // ã‚¿ã‚¤ãƒˆãƒ«
    document.getElementById('title').textContent = 'ğŸ§© QRã‚¯ã‚¨ã‚¹ãƒˆï¼š9åˆ†å‰²ã®é€²è¡ŒçŠ¶æ³';

    // æˆ»ã‚‹
    document.getElementById('backBtn').addEventListener('click', () => {
      location.href = 'start.html';
    });

    // ã‚°ãƒªãƒƒãƒ‰ç”Ÿæˆ
    const grid = document.getElementById('grid');
    grid.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;
    grid.style.width = `${cell * cols}px`;
    grid.style.height = `${cell * cols}px`;

    let found = 0;
    for (let n = 1; n <= total; n++) {
      const img = document.createElement('img');
      const has = (localStorage.getItem(`q_piece${n}`) === 'true' || localStorage.getItem(`piece${n}`) === 'true' || localStorage.getItem(`qrquest_piece${n}`) === 'true');
      if (has) found++;
      img.alt = `ãƒ”ãƒ¼ã‚¹${n}`;
      img.src = has ? `images/challenge/piece${n}.png` : 'images/blank.png';
      grid.appendChild(img);
    }

    document.getElementById('sub').textContent = `${found} / ${total}`;

    // âœ… å…¨ãƒ”ãƒ¼ã‚¹æƒã£ãŸã‚‰ãƒ•ã‚©ãƒ¼ãƒ ã¸
    if (found === total) {
      const audio = document.getElementById('fanfare');
      audio.play().catch(() => {});

      const formBtn = document.createElement('button');
      formBtn.textContent = 'ğŸ“ æŠ½é¸ä¼šã«å¿œå‹Ÿã™ã‚‹';
      formBtn.className = 'btn-reward';
      formBtn.onclick = () => {
        // TODO: Googleãƒ•ã‚©ãƒ¼ãƒ URLã¯å¾Œã§å·®ã—æ›¿ãˆ
        window.location.href = 'https://forms.gle/your-form-url';
      };
      document.body.appendChild(formBtn);

      const note = document.createElement('div');
      note.style.marginTop = '10px';
      note.style.fontSize = '0.9rem';
      note.style.color = '#6b4a2a';
      note.textContent = 'å¿œå‹Ÿãƒ•ã‚©ãƒ¼ãƒ ã«é€²ã¿ã€ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚';
      document.body.appendChild(note);
    }
  </script>

</head>
<body>

  <h1 id="title">ğŸ§­ ã¿ã¤ã‘ãŸ ãŠå®ãƒ”ãƒ¼ã‚¹ï¼</h1>
  <p class="sub" id="sub">0 / 0</p>

  <div class="grid" id="grid" aria-label="puzzle grid"></div>

  <div class="row">
    <button class="btn btn-sub" id="backBtn" onclick="location.href=\'start.html\'" onclick="location.href=\'start.html\'">â¬… ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹</button>
    <button class="btn" onclick="location.href='scanner/qr-scanner.html'">ğŸ“· ã‚¹ã‚­ãƒ£ãƒ³ã¸æˆ»ã‚‹</button>
  </div>

  <!-- âœ… ãƒ•ã‚¡ãƒ³ãƒ•ã‚¡ãƒ¼ãƒ¬éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ« -->
  <audio id="fanfare" src="sounds/fanfare.mp3" preload="auto"></audio>

  <script>
    // âœ… URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®å–å¾—ã¨è£œå®Œï¼ˆã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆè¨˜éŒ²ç”¨ï¼‰
    const urlParams = new URLSearchParams(window.location.search);
    const id = urlParams.get('id');
    const event = urlParams.get('event') || 'PROTO';
    const code = urlParams.get('code') || id || 'unknown';
    const type = urlParams.get('type') || (parseInt(code, 10) >= 100 ? 'dummy' : 'correct');
    const page = 'progress.html';

    // âœ… ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«è¨˜éŒ²ã‚’é€ã‚‹
    fetch('https://script.google.com/macros/s/AKfycbyE9PKDtOjTb1pFbnQFIrXLgDQ4s-kqVWFm2r7sJ9CZVbjt7DDfE4IsYCePGZQktfTFYg/exec', {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: new URLSearchParams({ event, code, type, page })
    })
    .then(res => res.text())
    .then(msg => console.log('é€ä¿¡çµæœ:', msg))
    .catch(err => console.error('é€ä¿¡å¤±æ•—:', err));

    // âœ… ãƒ¢ãƒ¼ãƒ‰åˆ¤å®šï¼ˆfamily=4ãƒ”ãƒ¼ã‚¹ / challenge=9ãƒ”ãƒ¼ã‚¹ï¼‰
    const mode = localStorage.getItem('mode') || 'family';
    const isChallenge = (mode === 'challenge');

    // ğŸ”’ ãƒ•ã‚¡ãƒŸãƒªãƒ¼ã¯ã€Œæœ¬éƒ¨QRï¼ˆ1æšç›®ï¼‰ã€ã‚’èª­ã‚€ã¾ã§é€²æ—ç”»é¢ã‚‚ãƒ­ãƒƒã‚¯
    const familyUnlocked = localStorage.getItem('family_unlocked') === 'true';
    if (!isChallenge && !familyUnlocked) {
      location.replace('family_need_hq.html');
      throw new Error('Progress locked: go to HQ first');
    }

// é€²æ—ã‚­ãƒ¼ï¼ˆfamilyã¯ piece1..4 / challengeã¯ c_piece1..9ï¼‰
    const pieceKey = (n) => isChallenge ? `c_piece${n}` : `piece${n}`;

    // ãƒ”ãƒ¼ã‚¹ç”»åƒã®å ´æ‰€
    const pieceSrc = (n) => isChallenge ? `images/challenge/piece${n}.png` : `images/piece${n}.png`;

    // ã‚°ãƒªãƒƒãƒ‰æ§‹æˆ
    const total = isChallenge ? 9 : 4;
    const cols = isChallenge ? 3 : 2;
    const cell = isChallenge ? 110 : 150; // ã‚¹ãƒãƒ›ã§è¦‹ã‚„ã™ã„ã‚µã‚¤ã‚º

    // ã‚¿ã‚¤ãƒˆãƒ«ãªã©
    document.getElementById('title').textContent = isChallenge
      ? 'ğŸ§­ ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã‚¯ã‚¨ã‚¹ãƒˆï¼šã¿ã¤ã‘ãŸ ãŠå®ãƒ”ãƒ¼ã‚¹ï¼'
      : 'ğŸ§­ ãƒ•ã‚¡ãƒŸãƒªãƒ¼ã‚¯ã‚¨ã‚¹ãƒˆï¼šã¿ã¤ã‘ãŸ ãŠå®ãƒ”ãƒ¼ã‚¹ï¼';

    // ãƒ¡ãƒ‹ãƒ¥ãƒ¼æˆ»ã‚Šå…ˆ
    document.getElementById('backBtn').addEventListener('click', () => {
      location.href = isChallenge ? 'start_challenge.html' : 'start.html';
    });

    // ã‚°ãƒªãƒƒãƒ‰ã‚’ç”Ÿæˆ
    const grid = document.getElementById('grid');
    grid.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;
    grid.style.width = `${cell * cols}px`;
    grid.style.height = `${cell * cols}px`;

    let found = 0;
    for (let n = 1; n <= total; n++) {
      const img = document.createElement('img');
      const has = localStorage.getItem(pieceKey(n)) === 'true';
      if (has) found++;
      img.id = `piece${n}`;
      img.alt = `ãƒ”ãƒ¼ã‚¹${n}`;
      img.src = has ? pieceSrc(n) : 'images/blank.png';
      grid.appendChild(img);
    }

    document.getElementById('sub').textContent = `${found} / ${total}`;

    // âœ… å…¨ãƒ”ãƒ¼ã‚¹æƒã£ãŸå ´åˆã®å‡¦ç†
    if (found === total) {
      const audio = document.getElementById('fanfare');
      audio.play().catch(() => console.log('éŸ³å£°ã®è‡ªå‹•å†ç”ŸãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ'));

      const rewardBtn = document.createElement('button');
      rewardBtn.textContent = 'ğŸ ãŠãŸã‹ã‚‰ã‚’ ã†ã‘ã¨ã‚‹';
      rewardBtn.className = 'btn-reward';
      rewardBtn.onclick = () => {
        location.href = 'reward_intro.html';
      };
      document.body.appendChild(rewardBtn);
    }
  </script>

</body>
</html>

<!doctype html>
<html lang="ja">
<head>
  <script src="event-config.js"></script>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>QR読み込み</title>
  <style>
    body{font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",sans-serif;margin:0;background:#f6f9ff;color:#1f2937}
    .wrap{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:18px}
    .card{width:100%;max-width:520px;background:#fff;border:1px solid #e5e7eb;border-radius:16px;box-shadow:0 10px 24px rgba(0,0,0,.08);padding:16px}
    h1{margin:0 0 6px;font-size:16px}
    p{margin:0;color:#6b7280;line-height:1.7;font-size:13px}
    .spin{width:22px;height:22px;border-radius:50%;border:3px solid #e5e7eb;border-top-color:#1e88e5;animation:spin 1s linear infinite;margin:12px 0}
    @keyframes spin{to{transform:rotate(360deg)}}
    .btn{display:inline-block;margin-top:12px;padding:10px 12px;border-radius:12px;border:1px solid #e5e7eb;background:#fff;color:#1f2937;font-weight:800;text-decoration:none}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>読み込み中…</h1>
      <div class="spin" aria-hidden="true"></div>
      <p id="msg">ページを移動します。</p>
      <a class="btn" href="index.html">ホームへ戻る</a>
    </div>
  </div>

<script>
  // ✅ 砂像QRは「1つだけ」で運用するための入口（ルーター）
  // 推奨QR形式：
  //   .../qr.html?mid=s01                （砂像解説のみ）
  //   .../qr.html?mid=s12&c=003          （チャレンジ用ピース3の砂像）
  //   .../qr.html?c=901                  （ダミーQR：砂像IDなし）
  // ファミリー用は必要なら：
  //   .../qr.html?mid=sXX&f=002          （ファミリー用ピース2）
  //
  // 動作：
  // - 未セットアップ：language → register → index（※登録後は再スキャン案内）
  // - セットアップ済み：
  //    mode=challenge：cがあれば resultへ（解説スキップ）
  //    mode=family   ：fがあれば resultへ
  //    mode=info/その他：midがあれば monumentへ（※cがあれば裏でチャレンジ進捗を記録）
  //
  const msg = (t)=>{ const el=document.getElementById('msg'); if(el) el.textContent=t; };

  const params = new URLSearchParams(location.search);
  const mid = params.get('mid') || params.get('monument') || params.get('id') || '';
  const c = params.get('c') || '';   // challenge piece or dummy
  const f = params.get('f') || '';   // family piece (optional)

  // 言語（旧キー互換）
  const lang = localStorage.getItem('lang') || localStorage.getItem('qrquest_lang') || '';

  if (!lang) {
    msg('言語選択へ移動します…');
    // 言語選択 → 登録 → ホーム（登録後は再スキャン案内）
    location.replace('language.html');
    throw new Error('no lang');
  }

  const registered = (localStorage.getItem('app_registered') === 'true');
  if (!registered) {
    msg('アプリ登録へ移動します…');
    try { localStorage.setItem('pending_qr', location.href); } catch(e){}
    location.replace('register.html');
    throw new Error('not registered');
  }

  // モード：info / challenge / family
  const mode = localStorage.getItem('mode') || 'info';

  const parseNum = (s)=>{
    const m = String(s||'').match(/\d+/);
    return m ? parseInt(m[0],10) : NaN;
  };

  const recordChallengeSilently = (code)=>{
    const n = parseNum(code);
    if (Number.isFinite(n) && n>=1 && n<=9){
      localStorage.setItem(`c_piece${n}`, 'true');
    }
  };

  // ① チャレンジモード：解説を飛ばして result へ
  if (mode === 'challenge') {
    if (c) {
      msg('チャレンジクエストの結果へ…');
      location.replace(`result.html?id=${encodeURIComponent(c)}`);
      throw new Error('to result challenge');
    }
    // cが無い砂像は、解説へ（クエスト外でも見られる）
  }

  // ② ファミリーモード：fがあれば result へ
  if (mode === 'family') {
    if (f) {
      msg('ファミリークエストの結果へ…');
      location.replace(`result.html?id=${encodeURIComponent(f)}`);
      throw new Error('to result family');
    }
  }

  // ③ 解説モード：砂像解説へ（cがあれば裏でチャレンジ進捗を記録）
  if (c && mode !== 'challenge') {
    recordChallengeSilently(c);
  }

  if (mid) {
    const url = `monument.html?id=${encodeURIComponent(mid)}${c ? `&c=${encodeURIComponent(c)}` : ''}${f ? `&f=${encodeURIComponent(f)}` : ''}`;
    msg('砂像解説へ移動します…');
    location.replace(url);
    throw new Error('to monument');
  }

  // midが無い（ダミーQRなど）
  if (mode === 'challenge' && c) {
    msg('チャレンジ結果へ…');
    location.replace(`result.html?id=${encodeURIComponent(c)}`);
  } else {
    msg('ホームへ移動します…');
    location.replace('index.html');
  }
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="ja">
<head>
  <script src="../event-config.js"></script>
  <meta charset="UTF-8" />
  <title>QRã‚¯ã‚¨ã‚¹ãƒˆ - ã‚¹ã‚­ãƒ£ãƒŠãƒ¼</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    /* iPhoneã§vhãŒæš´ã‚Œã‚‹å¯¾ç­– */
    :root { --vh: 1vh; }
    html, body { margin:0; padding:0; }

    body {
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", sans-serif;
      background-color: #fefefe;
      text-align: center;
      padding: 10px 12px 18px;
      overflow-x: hidden;
      min-height: calc(var(--vh) * 100);
      min-height: 100dvh;
      box-sizing: border-box;
      padding-bottom: env(safe-area-inset-bottom);
    }

    h1 {
      color: #007bff;
      font-size: 1.35rem;
      margin: 10px 0 10px;
      line-height: 1.4;
    }

    /* å›ºå®š300Ã—300ã‚’ã‚„ã‚ã‚‹ï¼ˆç¸®ã¿/å´©ã‚Œå¯¾ç­–ï¼‰ */
    #preview {
      width: min(86vw, 360px);
      aspect-ratio: 1 / 1;
      border: 1px solid #ccc;
      border-radius: 12px;
      margin: 14px auto 10px;
      background: #000;
      position: relative;
      overflow: hidden;
    }

    #preview video {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    #status {
      color: #666;
      font-size: 0.95rem;
      margin: 6px 0 2px;
    }

    #result {
      font-size: 1rem;
      color: #d32f2f;
      margin: 6px 0 12px;
      min-height: 1.2em;
      padding: 0 10px;
      word-break: break-word;
      white-space: pre-wrap;
    }

    .btn {
      margin: 6px;
      padding: 10px 18px;
      background-color: #4caf50;
      color: #fff;
      border: none;
      border-radius: 10px;
      font-size: 1rem;
      cursor: pointer;
      min-width: 140px;
    }

    .btn-exit { background-color: #ff7043; }
  </style>

  <script>
    function setVh(){
      document.documentElement.style.setProperty('--vh', (window.innerHeight * 0.01) + 'px');
    }
    setVh();
    window.addEventListener('resize', setVh);
  </script>

  <script>
  (function(){
    const lang = localStorage.getItem("lang") || "";
    const reg  = localStorage.getItem("app_registered") === "true";
    if(!lang){ location.replace("../language.html"); return; }
    if(!reg){ location.replace("../register.html"); return; }
  })();
  </script>

</head>

<body>
  <h1 id="title">ğŸ¯ QRã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿å–ã£ã¦<br>ã‚¯ã‚¨ã‚¹ãƒˆã‚’é€²ã‚ã‚ˆã†</h1>

  <div id="preview"></div>
  <p id="status">ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ä¸­â€¦</p>
  <div id="result"></div>

  <button onclick="rescan()" class="btn">ğŸ”„ å†ã‚¹ã‚­ãƒ£ãƒ³</button>
  <button onclick="exitToMenu()" class="btn btn-exit" id="exitBtn">ğŸ  ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹</button>

  <!-- html5-qrcode æœ¬ä½“ -->
  <script src="https://unpkg.com/html5-qrcode"></script>

  <script>
    // mode=test ã®ã¨ãã¯ã€Œãƒ†ã‚¹ãƒˆç”¨æŒ™å‹•ã€ã«ã™ã‚‹
    const params = new URLSearchParams(location.search);
    const mode = params.get("mode"); // "test" or null

    const titleEl = document.getElementById("title");
    const exitBtn = document.getElementById("exitBtn");

    if (mode === "test") {
      titleEl.innerHTML = "ğŸ“· ã‚«ãƒ¡ãƒ©ãƒ†ã‚¹ãƒˆ<br>QRã‚’1ã¤èª­ã¿å–ã£ã¦ã¿ã¦ãã ã•ã„";
      exitBtn.textContent = "â†© ãƒ†ã‚¹ãƒˆç”»é¢ã«æˆ»ã‚‹";
    }

    const html5QrCode = new Html5Qrcode("preview");
    const statusText = document.getElementById("status");
    const resultContainer = document.getElementById("result");

    // åŒä¸€ã‚³ãƒ¼ãƒ‰ã®é€£ç¶šåˆ¤å®šã‚’æŠ‘åˆ¶ã™ã‚‹ãŸã‚ã®ãƒ‡ãƒã‚¦ãƒ³ã‚¹
    let lastText = "";
    let lastAt = 0;

    // é·ç§»æ™‚ã®å¤šé‡ã‚¹ã‚¿ãƒ¼ãƒˆé˜²æ­¢ãƒ•ãƒ©ã‚°
    let hasRedirected = false;

    // ã‚«ãƒ¡ãƒ©é–‹å§‹
    async function startScanner() {
      try {
        await html5QrCode.start(
          { facingMode: "environment" },
          { fps: 10, qrbox: 250 },
          onScanSuccess,
          onScanFailure
        );
        statusText.innerText = "ã‚«ãƒ¡ãƒ©ãŒèµ·å‹•ã—ã¾ã—ãŸã€‚QRã‚³ãƒ¼ãƒ‰ã‚’ã‹ã–ã—ã¦ãã ã•ã„ã€‚";
      } catch (err) {
        statusText.innerText = "ã‚«ãƒ¡ãƒ©ã‚¨ãƒ©ãƒ¼ï¼š" + err;
      }
    }

    // ã‚«ãƒ¡ãƒ©åœæ­¢
    async function stopScanner() {
      try {
        if (html5QrCode._isScanning) {
          await html5QrCode.stop();
        }
      } catch (_) {
        // å¤±æ•—ã¯æ¡ã‚Šã¤ã¶ã—
      } finally {
        document.getElementById("preview").innerHTML = "";
      }
    }

    // ã‚¹ã‚­ãƒ£ãƒ³æˆåŠŸæ™‚
    function onScanSuccess(decodedText) {
      if (hasRedirected) return;

      // åŒä¸€å†…å®¹ã®é€£ç¶šãƒ’ãƒƒãƒˆã¯1.5ç§’ç„¡è¦–
      const now = Date.now();
      if (decodedText === lastText && now - lastAt < 1500) return;
      lastText = decodedText;
      lastAt = now;

      // â–¼ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ï¼šèª­ã¿å–ã‚ŒãŸã‚‰OKè¡¨ç¤ºã—ã¦åœæ­¢ï¼ˆã©ã“ã«ã‚‚é£›ã°ãªã„ï¼‰
      if (mode === "test") {
        resultContainer.innerText = "âœ… èª­ã¿å–ã‚ŠæˆåŠŸï¼\n" + decodedText;
        statusText.innerText = "ãƒ†ã‚¹ãƒˆOKã§ã™ã€‚æˆ»ã‚‹ãƒœã‚¿ãƒ³ã§æˆ»ã£ã¦ãã ã•ã„ã€‚";
        navigator.vibrate?.(60);
        stopScanner();
        return;
      }

      // URLä»¥å¤–ã¯ç„¡åŠ¹ï¼ˆã‚«ãƒ¡ãƒ©ã¯æ­¢ã‚ãªã„ï¼‰
      if (!decodedText.startsWith("http")) {
        resultContainer.innerText = "ç„¡åŠ¹ãªQRã‚³ãƒ¼ãƒ‰ã§ã™ã€‚ã‚‚ã†ä¸€åº¦ã‹ã–ã—ã¦ãã ã•ã„ã€‚";
        statusText.innerText = "æ­£ã—ã„QRã‚’ã‚‚ã†ä¸€åº¦ã‹ã–ã—ã¦ãã ã•ã„ã€‚";
        navigator.vibrate?.(80);
        return;
      }

      // URLãƒ‘ãƒ¼ã‚¹ã¨ãƒ›ãƒ¯ã‚¤ãƒˆãƒªã‚¹ãƒˆåˆ¤å®šï¼ˆã“ã“ãŒé‡è¦ï¼‰
      try {
        const url = new URL(decodedText);
        const domain = url.hostname;
        const path = url.pathname;

        const allowedDomain = (domain === "sakulink.com" || domain === "www.sakulink.com");
        const allowedProtocol = (url.protocol === "https:" || url.protocol === "http:");
        // ã“ã®ã‚¢ãƒ—ãƒªã§èª­ã¿å–ã£ã¦é·ç§»ã—ã¦ã‚ˆã„ãƒšãƒ¼ã‚¸ï¼ˆå…¬å¼ã®ã¿ï¼‰
        const allowedPath = /\/(progress|result|monument|qr|family_unlock)\.html$/.test(path);

        const allowed = allowedDomain && allowedProtocol && allowedPath;

        if (allowed) {
          // âœ… ã“ã®ã‚¹ã‚­ãƒ£ãƒŠãƒ¼çµŒç”±ã§ã‚ã‚‹ã“ã¨ã‚’ç¤ºã™ã€Œé€šè¡Œè¨¼ï¼ˆstï¼‰ã€ã‚’ä»˜ä¸
          // â€»æ¨™æº–ã‚«ãƒ¡ãƒ©ã§URLã‚’ç›´æ¥é–‹ã„ãŸå ´åˆã¯ st ãŒä»˜ã‹ãªã„ãŸã‚ã€ã‚¯ã‚¨ã‚¹ãƒˆé€²è¡Œã‚’ãƒ–ãƒ­ãƒƒã‚¯ã§ãã‚‹
          const st = (window.QRQUEST_SCANNER_AUTH && window.QRQUEST_SCANNER_AUTH.issue)
            ? window.QRQUEST_SCANNER_AUTH.issue()
            : "";

          if (st) {
            try { url.searchParams.set('st', st); } catch (_) {}
          }

          hasRedirected = true;
          stopScanner().finally(() => {
            window.location.href = url.toString();
          });
        } else {
          resultContainer.innerText = "ã“ã‚Œã¯å…¬å¼QRã‚¯ã‚¨ã‚¹ãƒˆç”¨ã‚³ãƒ¼ãƒ‰ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚";
          statusText.innerText = "æ­£ã—ã„QRã‚’ã‚‚ã†ä¸€åº¦ã‹ã–ã—ã¦ãã ã•ã„ã€‚";
          navigator.vibrate?.(80);
          return;
        }
      } catch {
        resultContainer.innerText = "èª­ã¿å–ã‚Šã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ã©ã†ãã€‚";
        statusText.innerText = "æ­£ã—ã„QRã‚’ã‚‚ã†ä¸€åº¦ã‹ã–ã—ã¦ãã ã•ã„ã€‚";
        return;
      }
    }

    // ã‚¹ã‚­ãƒ£ãƒ³å¤±æ•—æ™‚ï¼ˆãƒ•ãƒ¬ãƒ¼ãƒ æ¯ã®å¤±æ•—é€šçŸ¥ã€‚ä½•ã‚‚ã—ãªã„ï¼‰
    function onScanFailure(_) { /* no-op */ }

    // å†ã‚¹ã‚­ãƒ£ãƒ³
    async function rescan() {
      hasRedirected = false;
      resultContainer.innerText = "";
      statusText.innerText = "å†ã‚¹ã‚­ãƒ£ãƒ³ã‚’æº–å‚™ä¸­â€¦";
      await stopScanner();
      setTimeout(startScanner, 300);
    }

    // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹
    async function exitToMenu() {
      await stopScanner();
      if (mode === "test") {
        window.location.href = "../test-camera.html";
        return;
      }

      // âœ… ã‚³ãƒ¼ã‚¹åˆ¥ã«ã€Œæˆ»ã‚‹å…ˆã€ã‚’åˆ‡ã‚Šæ›¿ãˆï¼ˆãƒœã‚¿ãƒ³åã¯å¤‰æ›´ã—ãªã„ï¼‰
      const qmode = localStorage.getItem("mode") || "family";

      if (qmode === "challenge") {
        window.location.href = "../start_challenge.html";
      } else if (qmode === "family") {
        window.location.href = "../start.html";
      } else {
        // infoï¼ˆç ‚åƒè©³ç´°ï¼‰ã¯ãƒ›ãƒ¼ãƒ ï¼ˆindexï¼‰ã¸
        window.location.href = "../index.html";
      }
    }

    // ãƒšãƒ¼ã‚¸å¯è¦–çŠ¶æ…‹ã®å¤‰åŒ–ã§å†èµ·å‹•ï¼ˆå¾©å¸°æ™‚ã«å›ºã¾ã‚‹å¯¾ç­–ï¼‰
    document.addEventListener("visibilitychange", () => {
      if (document.visibilityState === "visible" && !hasRedirected) {
        startScanner();
      }
    });

    // ãƒšãƒ¼ã‚¸é·ç§»/ç ´æ£„æ™‚ã¯æ˜ç¤ºåœæ­¢
    window.addEventListener("pagehide", stopScanner);
    window.addEventListener("beforeunload", stopScanner);

    // åˆå›èµ·å‹•
    startScanner();
  </script>
</body>
</html>
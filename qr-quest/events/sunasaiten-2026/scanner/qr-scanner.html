<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>QR„ÇØ„Ç®„Çπ„Éà - „Çπ„Ç≠„É£„Éä„Éº</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <style>
    body { font-family: sans-serif; background-color:#fefefe; text-align:center; padding:10px; margin:0; overflow-x:hidden; }
    h1 { color:#007bff; font-size:1.6rem; margin-bottom:12px; line-height:1.4; }
    #preview { width:300px; height:300px; border:1px solid #ccc; margin:20px auto; background:black; position:relative; border-radius:12px; overflow:hidden; }
    #preview video, #preview canvas { width:100% !important; height:100% !important; object-fit:cover; }
    #status, #result { margin:8px auto; max-width:520px; font-size:0.95rem; line-height:1.5; color:#444; word-break:break-all; }
    .btn { display:inline-block; margin:10px 6px; padding:12px 14px; border:none; border-radius:12px; background:#007bff; color:#fff; font-size:1rem; cursor:pointer; }
    .btn:disabled { opacity:.5; cursor:not-allowed; }
    .btn-exit { background:#6c757d; }
  </style>
  <script src="./lib/html5-qrcode.min.js"></script>
  <script src="../event-config.js"></script>
    <script src="../pwa-guard.js"></script>
<script>
    // Ë™≠„ÅøÂèñ„ÇäÂÆå‰∫ÜÂæå„ÄÅÂÅúÊ≠¢Âá¶ÁêÜ„ÅåË©∞„Åæ„Å£„Å¶„ÇÇÈÅ∑Áßª„Åß„Åç„Çã„Çà„ÅÜ„Å´ÂÆâÂÖ®ÂÅúÊ≠¢„Éò„É´„Éë„Éº„ÇíÁî®ÊÑè
    function forceStopMediaTracks(){
      try{
        const root = document.getElementById('preview');
        if(!root) return;
        const v = root.querySelector('video');
        const stream = v && v.srcObject;
        if(stream && stream.getTracks){
          stream.getTracks().forEach(t=>{ try{ t.stop(); }catch(e){} });
        }
        if(v){ try{ v.srcObject = null; }catch(e){} }
      }catch(e){}
    }

    function stopScannerSafely(){
      // iOS(PWA/Safari) „Åß„ÅØ start() ÂÆå‰∫ÜÂâç„Å´Èõ¢ËÑ±„Åô„Çã„Å® stop() „ÅåÂëº„Åπ„Åö„ÄÅ„Ç´„É°„É©„ÅåÊÆã„Çã„Åì„Å®„Åå„ÅÇ„Çã
      // ‚Üí stop() / clear() „ÇíË©¶„Åó„Å§„Å§„ÄÅÊúÄÂæå„Å´ MediaStream „ÅÆ track „ÇíÂº∑Âà∂ÂÅúÊ≠¢„Åô„Çã
      const inst = window.__html5QrCodeInstance;
      return (async ()=>{
        try{ if(inst){ await inst.stop(); } }catch(e){}
        try{ if(inst){ await inst.clear(); } }catch(e){}
        forceStopMediaTracks();
      })();
    }
  </script>
</head>
<body>
  <h1>QR„ÇØ„Ç®„Çπ„Éà - „Çπ„Ç≠„É£„Éä„Éº</h1>
  <div id="preview"></div>
  <div id="status">„Ç´„É°„É©„ÇíËµ∑Âãï‰∏≠‚Ä¶</div>
  <div id="result"></div>
  <div>
    <button id="btnRescan" class="btn">üîÑ ÂÜç„Çπ„Ç≠„É£„É≥</button>
    <button id="btnExit" class="btn btn-exit">üè† „É°„Éã„É•„Éº„Å´Êàª„Çã</button>
  </div>

<script>
  const params = new URLSearchParams(location.search);
  // return„ÅØ "start.html" „ÅÆ„Çà„ÅÜ„Å´Ê∏°„Åï„Çå„Çã„ÅÆ„Åß„ÄÅÂêåÈöéÂ±§„Å∏Êàª„Åô
  const mode = params.get('mode') || 'normal';
    // startkey „É¢„Éº„Éâ„Åß„ÅØ„ÄåÈñãÂßãÊ∏à„Åø„Äç„Çí„Çª„ÉÉ„Éà„Åô„Çã„Å†„Åë„Åß„ÄÅ„Éù„Ç§„É≥„ÉàÔºà„Éî„Éº„ÇπÔºâ„ÅÆËß£Êîæ„ÅØË°å„ÅÑ„Åæ„Åõ„Çì„ÄÇ
    const isStartKeyMode = (mode === 'startkey');
  const returnParam = params.get('return');
  const backParam = params.get('back');
  const returnTargetDefault = (mode === 'reward') ? '../reward_get.html' : '../start.html';
  const returnTarget = returnParam || returnTargetDefault;
  const backTarget = backParam || returnTarget;

  const html5QrCode = new Html5Qrcode("preview");
  // stopScannerSafely() Áî®„Å´ÂÖ¨Èñã
  window.__html5QrCodeInstance = html5QrCode;
  const statusText = document.getElementById("status");
  const resultContainer = document.getElementById("result");
  const btnRescan = document.getElementById("btnRescan");
  const btnExit = document.getElementById("btnExit");

  let lastText = "";
  let lastAt = 0;
  let hasRedirected = false;
  let isScanning = false;

  function setButtonsEnabled(on){
    btnRescan.disabled = !on;
    btnExit.disabled = !on;
  }

  async function startScanner() {
    try {
      setButtonsEnabled(false);
      await html5QrCode.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: 250 },
        onScanSuccess,
        onScanFailure
      );
      isScanning = true;
      statusText.innerText = "„Ç´„É°„É©„ÅåËµ∑Âãï„Åó„Åæ„Åó„Åü„ÄÇQR„Ç≥„Éº„Éâ„Çí„Åã„Åñ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ";
      setButtonsEnabled(true);
    } catch (e) {
      isScanning = false;
      statusText.innerText = "„Ç´„É°„É©„ÅÆËµ∑Âãï„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ„Éñ„É©„Ç¶„Ç∂„ÅÆ„Ç´„É°„É©Ë®±ÂèØ„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ";
      resultContainer.innerText = String(e);
      setButtonsEnabled(true);
    }
  }

  async function stopScanner() {
    // start() „ÅåÂÆå‰∫Ü„Åó„Å¶„ÅÑ„Å™„Åè„Å¶„ÇÇÁ¢∫ÂÆü„Å´„Ç´„É°„É©„ÇíÊ≠¢„ÇÅ„Çã
    await Promise.race([stopScannerSafely(), new Promise(r=>setTimeout(r,700))]);
    isScanning = false;
  }

  function onScanFailure(_error) {}

  async function onScanSuccess(decodedText, _decodedResult) {
        // STARTKEY_ONLY: Âèó‰ªò„Çπ„Çø„Éº„ÉàQR„ÅØ„ÄåÊñáÂ≠óÂàó„Çí‰øùÂ≠ò ‚Üí Âèó‰ªòÂà§ÂÆö„Éö„Éº„Ç∏„Å∏ÈÅ∑Áßª„Äç„Å†„ÅëË°å„ÅÜÔºà„Åì„Åì„Åß„ÅØ started „ÇíÁ´ã„Å¶„Å™„ÅÑÔºâ
        if (typeof isStartKeyMode !== 'undefined' && isStartKeyMode) {
          const t = (decodedText || '').trim();
          const tl = t.toLowerCase();
          const looksLikeStart =
            tl.includes('start') ||
            tl.includes('shiyakusho') || tl.includes('cityhall') || tl.includes('Â∏ÇÂΩπÊâÄ') ||
            tl.includes('honmachi')   || tl.includes('Êú¨Áî∫') ||
            tl.includes('fumoto')     || tl.includes('È∫ì');

          if(!looksLikeStart){
            alert('„Åì„Çå„ÅØ„Çπ„Çø„Éº„ÉàQR„Åß„ÅØ„Å™„ÅÑ„Çà„ÅÜ„Åß„Åô„ÄÇÂèó‰ªò„ÅßÈÖçÂ∏É„Åï„Çå„Åü„Çπ„Çø„Éº„ÉàQR„ÇíË™≠„ÅøËæº„Çì„Åß„Åè„Å†„Åï„ÅÑ„ÄÇ');
            // „ÇÇ„ÅÜ‰∏ÄÂ∫¶„Çπ„Ç≠„É£„É≥„Åß„Åç„Çã„Çà„ÅÜ„Å´Êàª„Åô
            hasRedirected = false;
            setTimeout(()=>rescan(), 120);
            return;
          }

          try {
            // start_after_key.html „ÅßÂà§ÂÆö„Å´‰Ωø„ÅÜ
            localStorage.setItem('start_scan_text', t);
            // ‚úÖ startQR„ÅØ„ÄåÈÄ≤Ë°åÁî®„ÅÆscan_text„Äç„Å´ÂÖ•„Çå„Å™„ÅÑ
            // Ôºàstart.htmlÂÅ¥„ÅÆÂú∞ÁÇπQRÂà§ÂÆö„ÅåË™§‰ΩúÂãï„Åó„Å¶„ÄÅ„Éî„Éº„Çπ2„Å™„Å©„ÅåÊúÄÂàù„Åã„Çâ‰ªò‰∏é„Åï„Çå„Çã„ÅÆ„ÇíÈò≤„ÅêÔºâ
            // ‰∫íÊèõ„ÅåÂøÖË¶Å„Å™„Çâ start_scan_text „ÇíÂèÇÁÖß„Åô„Çã
          } catch(e) {}

          Promise.race([stopScannerSafely(), new Promise(r=>setTimeout(r,600))]).finally(() => {
            setTimeout(()=>{ window.location.replace(returnTarget); }, 120);
          });
          return;
        }

    const now = Date.now();
    if (decodedText === lastText && (now - lastAt) < 1200) return;
    lastText = decodedText;
    lastAt = now;
    resultContainer.innerText = decodedText;
    if (hasRedirected) return;
    hasRedirected = true;

    // reward„É¢„Éº„Éâ„Å™„Çâ„ÄÅÂèÇÂä†Ë≥ûÁî®QR„Å†„ÅëÈÄö„ÅôÔºà'reward'„ÇíÂê´„ÇÄÊÉ≥ÂÆöÔºâ
    if(mode === 'reward'){
      const ok = decodedText && (decodedText.includes('reward') || decodedText.includes('REWARD'));
      if(!ok){
        alert('ÂèÇÂä†Ë≥û„Ç≤„ÉÉ„ÉàÁî®QR„Åß„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ‰øÇÂì°„ÅÆQR„ÇíË™≠„ÅøËæº„Çì„Åß„Åè„Å†„Åï„ÅÑ„ÄÇ');
        hasRedirected = false;
        setTimeout(()=>rescan(), 100);
        return;
      }
      try{ localStorage.setItem('reward_scan_text', decodedText); }catch(e){}
    }

    await Promise.race([stopScanner(), new Promise(r=>setTimeout(r,600))]);
    try{
      localStorage.setItem("scan_text", decodedText);
      localStorage.setItem("last_scan_text", decodedText);
    }catch(e){}
    // ÂõûÈÅä„É≠„Ç∞Ôºà„Çπ„Ç≠„É£„É≥„Ç§„Éô„É≥„ÉàÔºâ
    try{
      if(window.QRQUEST_LOG){
        const short = (decodedText || '').toString().slice(0, 120);
        // ÂèØËÉΩ„Å™„Çâ„ÄÅ„Ç®„É™„Ç¢Âêç„Å®„Éî„Éº„ÇπÁï™Âè∑„ÇÇÊé®ÂÆö„Åó„Å¶„É≠„Ç∞„Å∏ÂÖ•„Çå„Çã
        const lower = (decodedText || '').toLowerCase();
        let areaId = "";
        if(lower.includes('shiyakusho') || lower.includes('cityhall') || lower.includes('Â∏ÇÂΩπÊâÄ')) areaId = 'shiyakusho';
        else if(lower.includes('honmachi1') || lower.includes('honmachi-1') || lower.includes('honmachi_1') || lower.includes('Êú¨Áî∫1')) areaId = 'honmachi1';
        else if(lower.includes('honmachi2') || lower.includes('honmachi-2') || lower.includes('honmachi_2') || lower.includes('Êú¨Áî∫2')) areaId = 'honmachi2';
        else if(lower.includes('fumoto1') || lower.includes('fumoto-1') || lower.includes('fumoto_1') || lower.includes('È∫ì1')) areaId = 'fumoto1';
        else if(lower.includes('fumoto2') || lower.includes('fumoto-2') || lower.includes('fumoto_2') || lower.includes('È∫ì2')) areaId = 'fumoto2';
        else if(lower.includes('fumoto3') || lower.includes('fumoto-3') || lower.includes('fumoto_3') || lower.includes('È∫ì3')) areaId = 'fumoto3';
        else if(lower.includes('fumoto4') || lower.includes('fumoto-4') || lower.includes('fumoto_4') || lower.includes('È∫ì4')) areaId = 'fumoto4';
        const map = { shiyakusho:2, honmachi1:3, honmachi2:4, fumoto4:5, fumoto1:6, fumoto2:7, fumoto3:8 };
        const pieceGuess = (areaId && map[areaId]) ? String(map[areaId]) : "";
        window.QRQUEST_LOG.send({
          page: "qr-scanner.html",
          area: areaId,
          qr_id: short,
          result: (mode === 'reward' ? "scan_reward" : "scan"),
          piece: pieceGuess,
        });
      }
    }catch(e){}
    location.href = returnTarget;
  }

  async function rescan() {
    statusText.innerText = "ÂÜç„Çπ„Ç≠„É£„É≥Ê∫ñÂÇô‰∏≠‚Ä¶";
    await Promise.race([stopScanner(), new Promise(r=>setTimeout(r,600))]);
    hasRedirected = false;
    lastText = "";
    lastAt = 0;
    setTimeout(() => startScanner(), 150);
  }

  async function exitToMenu() {
      statusText.innerText = "„É°„Éã„É•„Éº„Å∏Êàª„Çä„Åæ„Åô‚Ä¶";
      setButtonsEnabled(false);
      await Promise.race([stopScannerSafely(), new Promise(r=>setTimeout(r,700))]);
      await new Promise(r=>setTimeout(r,120));
      location.href = backTarget;
    }

  btnRescan.addEventListener('click', rescan);
  btnExit.addEventListener('click', exitToMenu);

  window.addEventListener("load", startScanner);
  // iOS(PWA) „Åß„Éõ„Éº„É†„Ç¢„Ç§„Ç≥„É≥Ëµ∑Âãï„ÉªÂæ©Â∏∞ÊôÇ„Å´ bfcache „ÅßÁä∂ÊÖã„ÅåÊÆã„Çä„ÄÅÈÅ∑Áßª„Åó„Å™„ÅÑ‰∫ã„Åå„ÅÇ„Çã„Åü„ÇÅÂÜçÂàùÊúüÂåñ
  window.addEventListener("pageshow", (ev)=>{
    if(ev && ev.persisted){
      hasRedirected = false; lastText = ""; lastAt = 0;
      setTimeout(()=>rescan(), 120);
    }
  });
  window.addEventListener("visibilitychange", ()=>{
    if(document.visibilityState === "visible" && !isScanning){
      // „Éê„ÉÉ„ÇØ„Ç∞„É©„Ç¶„É≥„ÉâÂæ©Â∏∞„Åß„Ç´„É°„É©ÂÅúÊ≠¢„Åó„Å¶„ÅÑ„ÅüÂ†¥Âêà
      setTimeout(()=>startScanner(), 120);
    }
  });
  window.addEventListener("pagehide", stopScanner);
  window.addEventListener("beforeunload", stopScanner);
</script>
</body>
</html>

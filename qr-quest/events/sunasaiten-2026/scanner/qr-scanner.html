<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>QRã‚¯ã‚¨ã‚¹ãƒˆ - ã‚¹ã‚­ãƒ£ãƒŠãƒ¼</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    /* iPhoneã§vhãŒæš´ã‚Œã‚‹å¯¾ç­– */
    :root { --vh: 1vh; }
    html, body { margin:0; padding:0; }

    body {
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", sans-serif;
      background-color: #fefefe;
      text-align: center;
      padding: 10px 12px 18px;
      overflow-x: hidden;
      min-height: calc(var(--vh) * 100);
      min-height: 100dvh;
      box-sizing: border-box;
      padding-bottom: env(safe-area-inset-bottom);
    }

    h1 {
      color: #007bff;
      font-size: 1.35rem;
      margin: 10px 0 10px;
      line-height: 1.4;
    }

    /* ç”»é¢ã«åˆã‚ã›ã¦ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ä¼¸ç¸®ã•ã›ã‚‹ï¼ˆå›ºå®š300Ã—300ã‚’ã‚„ã‚ã‚‹ï¼‰ */
    #preview {
      width: min(86vw, 360px);
      aspect-ratio: 1 / 1;
      border: 1px solid #ccc;
      border-radius: 12px;
      margin: 14px auto 10px;
      background: #000;
      position: relative;
      overflow: hidden;
    }

    #preview video {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    #status {
      color: #666;
      font-size: 0.95rem;
      margin: 6px 0 2px;
    }

    #result {
      font-size: 1rem;
      color: #d32f2f;
      margin: 6px 0 12px;
      min-height: 1.2em;
      padding: 0 10px;
      word-break: break-word;
    }

    .btn {
      margin: 6px;
      padding: 10px 18px;
      background-color: #4caf50;
      color: #fff;
      border: none;
      border-radius: 10px;
      font-size: 1rem;
      cursor: pointer;
      min-width: 140px;
    }

    .btn-exit { background-color: #ff7043; }
  </style>

  <script>
    function setVh(){
      document.documentElement.style.setProperty('--vh', (window.innerHeight * 0.01) + 'px');
    }
    setVh();
    window.addEventListener('resize', setVh);
  </script>
</head>

<body>
  <h1 id="title">ğŸ¯ QRã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿å–ã£ã¦<br>ã‚¯ã‚¨ã‚¹ãƒˆã‚’é€²ã‚ã‚ˆã†</h1>

  <div id="preview"></div>
  <p id="status">ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ä¸­â€¦</p>
  <div id="result"></div>

  <button onclick="rescan()" class="btn">ğŸ”„ å†ã‚¹ã‚­ãƒ£ãƒ³</button>
  <button onclick="exitToMenu()" class="btn btn-exit" id="exitBtn">ğŸ  ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹</button>

  <!-- html5-qrcode æœ¬ä½“ -->
  <script src="https://unpkg.com/html5-qrcode"></script>

  <script>
    // mode=test ã®ã¨ãã¯ã€Œãƒ†ã‚¹ãƒˆç”¨æŒ™å‹•ã€ã«ã™ã‚‹
    const params = new URLSearchParams(location.search);
    const mode = params.get("mode"); // "test" or null

    const titleEl = document.getElementById("title");
    const exitBtn = document.getElementById("exitBtn");

    if (mode === "test") {
      titleEl.innerHTML = "ğŸ“· ã‚«ãƒ¡ãƒ©ãƒ†ã‚¹ãƒˆ<br>QRã‚’1ã¤èª­ã¿å–ã£ã¦ã¿ã¦ãã ã•ã„";
      exitBtn.textContent = "â†© ãƒ†ã‚¹ãƒˆç”»é¢ã«æˆ»ã‚‹";
    }

    const html5QrCode = new Html5Qrcode("preview");
    const statusText = document.getElementById("status");
    const resultContainer = document.getElementById("result");

    let lastText = "";
    let lastAt = 0;
    let hasRedirected = false;

    async function startScanner() {
      try {
        await html5QrCode.start(
          { facingMode: "environment" },
          { fps: 10, qrbox: 250 },
          onScanSuccess,
          onScanFailure
        );
        statusText.innerText = "ã‚«ãƒ¡ãƒ©ãŒèµ·å‹•ã—ã¾ã—ãŸã€‚QRã‚³ãƒ¼ãƒ‰ã‚’ã‹ã–ã—ã¦ãã ã•ã„ã€‚";
      } catch (err) {
        statusText.innerText = "ã‚«ãƒ¡ãƒ©ã‚¨ãƒ©ãƒ¼ï¼š" + err;
      }
    }

    async function stopScanner() {
      try {
        if (html5QrCode._isScanning) {
          await html5QrCode.stop();
        }
      } catch (_) {
      } finally {
        document.getElementById("preview").innerHTML = "";
      }
    }

    function onScanSuccess(decodedText) {
      if (hasRedirected) return;

      const now = Date.now();
      if (decodedText === lastText && now - lastAt < 1500) return;
      lastText = decodedText;
      lastAt = now;

      // â–¼ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ï¼šèª­ã¿å–ã‚ŒãŸã‚‰ã€ŒOKè¡¨ç¤ºã€ã§æ­¢ã‚ã‚‹ï¼ˆã©ã“ã«ã‚‚é£›ã°ãªã„ï¼‰
      if (mode === "test") {
        resultContainer.innerText = "âœ… èª­ã¿å–ã‚ŠæˆåŠŸï¼\n" + decodedText;
        statusText.innerText = "ãƒ†ã‚¹ãƒˆOKã§ã™ã€‚æˆ»ã‚‹ãƒœã‚¿ãƒ³ã§æˆ»ã£ã¦ãã ã•ã„ã€‚";
        navigator.vibrate?.(60);

        // ã‚«ãƒ¡ãƒ©ã‚’æ­¢ã‚ã¦å›ºã¾ã‚Šã«ããã™ã‚‹
        stopScanner();
        return;
      }

      // â–¼é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ï¼ˆã“ã“ã‹ã‚‰ä¸‹ã¯ä»Šã¾ã§é€šã‚Šã®å³æ ¼åˆ¤å®šï¼‰
      if (!decodedText.startsWith("http")) {
        resultContainer.innerText = "ç„¡åŠ¹ãªQRã‚³ãƒ¼ãƒ‰ã§ã™ã€‚ã‚‚ã†ä¸€åº¦ã‹ã–ã—ã¦ãã ã•ã„ã€‚";
        statusText.innerText = "æ­£ã—ã„QRã‚’ã‚‚ã†ä¸€åº¦ã‹ã–ã—ã¦ãã ã•ã„ã€‚";
        navigator.vibrate?.(80);
        return;
      }

      try {
        const url = new URL(decodedText);
        const domain = url.hostname;
        const path = url.pathname;

        const allowed =
          domain === "sakulink.com" &&
          (
            path === "/qr-quest/progress.html" ||
            path === "/qr-quest/result.html" ||
            /^\/qr-quest\/events\/[^\/]+\/(progress|result)\.html$/.test(path)
          );

        if (allowed) {
          hasRedirected = true;
          stopScanner().finally(() => {
            window.location.href = decodedText;
          });
        } else {
          resultContainer.innerText = "ã“ã‚Œã¯å…¬å¼QRã‚¯ã‚¨ã‚¹ãƒˆç”¨ã‚³ãƒ¼ãƒ‰ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚";
          statusText.innerText = "æ­£ã—ã„QRã‚’ã‚‚ã†ä¸€åº¦ã‹ã–ã—ã¦ãã ã•ã„ã€‚";
          navigator.vibrate?.(80);
          return;
        }
      } catch {
        resultContainer.innerText = "èª­ã¿å–ã‚Šã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ã©ã†ãã€‚";
        statusText.innerText = "æ­£ã—ã„QRã‚’ã‚‚ã†ä¸€åº¦ã‹ã–ã—ã¦ãã ã•ã„ã€‚";
        return;
      }
    }

    function onScanFailure(_) { /* no-op */ }

    async function rescan() {
      hasRedirected = false;
      resultContainer.innerText = "";
      statusText.innerText = "å†ã‚¹ã‚­ãƒ£ãƒ³ã‚’æº–å‚™ä¸­â€¦";
      await stopScanner();
      setTimeout(startScanner, 300);
    }

    async function exitToMenu() {
      await stopScanner();
      // ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ã¯ test-cameraã¸æˆ»ã™ã€‚é€šå¸¸ã¯ startã¸æˆ»ã™ã€‚
      if (mode === "test") {
        window.location.href = "../test-camera.html";
      } else {
        window.location.href = "../start.html";
      }
    }

    document.addEventListener("visibilitychange", () => {
      if (document.visibilityState === "visible" && !hasRedirected) {
        startScanner();
      }
    });

    window.addEventListener("pagehide", stopScanner);
    window.addEventListener("beforeunload", stopScanner);

    startScanner();
  </script>
</body>
</html>

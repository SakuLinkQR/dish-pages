<!DOCTYPE html>
<html lang="ja">
<head>
  <script src="event-config.js"></script>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>„Çπ„Ç≠„É£„É≥ÁµêÊûú</title>
  <link href="https://fonts.googleapis.com/css2?family=DotGothic16&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'DotGothic16', sans-serif;
      background-color: #fffaf2;
      text-align: center;
      padding: 40px 20px;
      margin: 0;
    }
    h1 {
      font-size: 1.8rem;
      margin-bottom: 18px;
      color: #4b2e0d;
      line-height: 1.3;
    }
    p {
      font-size: 1.15rem;
      margin: 0 0 20px;
      color: #6b4a2a;
      line-height: 1.6;
    }
    .btn {
      display: block;
      width: 88%;
      max-width: 320px;
      margin: 12px auto;
      padding: 12px 18px;
      font-size: 1.05rem;
      border: none;
      border-radius: 10px;
      background-color: #4fa3ff;
      color: white;
      cursor: pointer;
      font-weight: 900;
    }
    .btn:hover { background-color: #1e88e5; }

    /* ÂÆùÁÆ±ÊºîÂá∫ */
    .reveal {
      position: relative;
      width: 260px;
      height: 260px;
      margin: 0 auto 22px;
      border-radius: 18px;
      background: rgba(0,0,0,.03);
      border: 1px solid rgba(0,0,0,.06);
      overflow: hidden;
      box-shadow: 0 10px 24px rgba(0,0,0,.08);
    }
    .reveal img {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .reveal .door {
      background: linear-gradient(180deg, rgba(120,84,40,.90), rgba(90,60,22,.95));
      border-radius: 18px;
      transform: translateX(0);
      transition: transform .65s ease;
    }
    .reveal.open .door { transform: translateX(-105%); }
    .spark {
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at 50% 40%, rgba(255,219,88,.75), rgba(255,219,88,0) 55%);
      opacity: 0;
      transition: opacity .55s ease;
    }
    .reveal.open .spark { opacity: 1; }
  </style>

  <script>
  (function(){
    const lang = localStorage.getItem("lang") || "";
    const reg  = localStorage.getItem("app_registered") === "true";
    if(!lang){ location.replace("language.html"); return; }
    if(!reg){ location.replace("register.html"); return; }
  })();
  </script>

</head>
<body>

  <div class="reveal" id="reveal" aria-hidden="true" style="display:none;">
    <img src="images/vines.png" alt="" style="opacity:.08;" />
    <div class="spark"></div>
    <img src="images/door.png" alt="" class="door" />
  </div>

  <h1 id="title">„Çπ„Ç≠„É£„É≥ÁµêÊûú</h1>
  <p id="message">Ë™≠„ÅøËæº„Åø‰∏≠...</p>

  <button class="btn" id="menuBtn">„É°„Éã„É•„Éº„Å∏Êàª„Çã</button>
  <button class="btn" id="progressBtn">ÈÄ≤Ë°åÁä∂Ê≥Å„ÇíË¶ã„Çã</button>

  <script>
    const params = new URLSearchParams(window.location.search);
    const idRaw = params.get('id') || '';

    // ‚úÖ „É¢„Éº„ÉâÂà§ÂÆöÔºàfamily=4 / challenge=9Ôºâ
    const mode = localStorage.getItem('mode') || 'family';
    const isChallenge = (mode === 'challenge');
    const totalCorrect = isChallenge ? 9 : 4;

    // ‚úÖ „Éî„Éº„ÇπÁï™Âè∑„Çí„Éë„Éº„ÇπÔºà"001" „Åß„ÇÇOKÔºâ
    const m = String(idRaw).match(/\d+/);
    const pieceNum = m ? parseInt(m[0], 10) : NaN;

    // ‚úÖ Ê≠£Ëß£QR„Åã„Å©„ÅÜ„Åã
    const isCorrect = Number.isFinite(pieceNum) && pieceNum >= 1 && pieceNum <= totalCorrect;


    // ‚úÖ ÈÄ≤Êçó„Ç≠„ÉºÔºàfamily„ÅØ piece1..4 / challenge„ÅØ c_piece1..9Ôºâ
    const pieceKey = (n) => isChallenge ? `c_piece${n}` : `piece${n}`;

    // ‚úÖ „É≠„Ç∞Áî®
    const event = (window.QRQUEST_EVENT && window.QRQUEST_EVENT.id) ? window.QRQUEST_EVENT.id : 'PROTO';
    const code = m ? String(pieceNum).padStart(3,'0') : (idRaw || 'unknown');
    const type = isCorrect ? 'correct' : 'dummy';
    const page = 'result.html';

    // ‚úÖ „Çπ„Éó„É¨„ÉÉ„Éâ„Ç∑„Éº„Éà„Å´Ë®òÈå≤„ÇíÈÄÅ„Çã
    fetch('https://script.google.com/macros/s/AKfycbyE9PKDtOjTb1pFbnQFIrXLgDQ4s-kqVWFm2r7sJ9CZVbjt7DDfE4IsYCePGZQktfTFYg/exec', {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: new URLSearchParams({ event, code, type, page })
    }).catch(() => {});

    // ‚úÖ „Éú„Çø„É≥„ÅÆÊàª„ÇäÂÖà
    const menuHref = isChallenge ? 'start_challenge.html' : 'start.html';
    document.getElementById('menuBtn').onclick = () => location.href = menuHref;
    document.getElementById('progressBtn').onclick = () => location.href = `progress.html?event=${encodeURIComponent(event)}&code=${encodeURIComponent(code)}&type=${encodeURIComponent(type)}`;

    const titleEl = document.getElementById('title');
    const msgEl = document.getElementById('message');
    const revealEl = document.getElementById('reveal');

    // ‚úÖ „ÉÄ„Éü„ÉºÊñáË®Ä
    const dummyTexts = [
      '„ÅÇ„Çå„ÇåÔºü„Åì„Çå„ÅØ„ÉÄ„Éü„ÉºQR„Åã„ÇÇÔºÅ\nËøë„Åè„Çí„Çà„Éº„ÅèË¶ã„Å¶„Åø„Çà„ÅÜÔºÅ',
      '„Åñ„Çì„Å≠„ÇìÔºÅ„Åì„Çå„ÅØ„Éï„Çß„Ç§„É≥„Éà„Å†ÔºÅ\n„Åß„ÇÇ„Éí„É≥„Éà„Åå„ÅÇ„Çã„Åã„ÇÇÔºü',
      '„Åä„Å£„Å®ÔºÅ„Åæ„Å°„Åå„ÅÑQR„Å†ÔºÅ\nÊú¨Áâ©„ÅØ„Åô„ÅêËøë„Åè„Å†„ÇàÔºÅ',
      '„ÉÄ„Éü„ÉºQRÁô∫Ë¶ãÔºÅ\n„ÅÇ„Åç„Çâ„ÇÅ„Åö„Å´Êé¢„Åù„ÅÜÔºÅ'
    ];

    if (!isCorrect) {
      titleEl.textContent = 'üòµ „ÅÇ„ÇåÔºü„Å°„Åå„ÅÜ„Åø„Åü„ÅÑ‚Ä¶';
      msgEl.textContent = dummyTexts[Math.floor(Math.random() * dummyTexts.length)];
    } else {

      // üîí „Éï„Ç°„Éü„É™„Éº„ÅØ„ÄåÊú¨ÈÉ®QRÔºà1ÊûöÁõÆÔºâ„Äç„ÇíË™≠„ÇÄ„Åæ„ÅßÈÄ≤„ÇÅ„Å™„ÅÑ
      const familyUnlocked = localStorage.getItem('family_unlocked') === 'true';
      if (!isChallenge && !familyUnlocked) {
        location.replace('family_need_hq.html');
        throw new Error('Family quest locked (branch): go to HQ first');
      }

      const already = localStorage.getItem(pieceKey(pieceNum)) === 'true';
      localStorage.setItem(pieceKey(pieceNum), 'true');

      // ÊºîÂá∫
      revealEl.style.display = 'block';
      revealEl.setAttribute('aria-hidden','false');
      requestAnimationFrame(() => revealEl.classList.add('open'));

      titleEl.textContent = already ? '‚úÖ „Åì„Çå„ÅØ „ÇÇ„ÅÜ „ÇÇ„Å£„Å¶„ÅÑ„Çã„Éî„Éº„ÇπÔºÅ' : 'üéâ „ÅäÂÆù„ÇíGET„Åó„ÅüÔºÅ';
      msgEl.textContent = isChallenge
        ? `„Éî„Éº„Çπ ${pieceNum} „ÇíÊâã„Å´ÂÖ•„Çå„ÅüÔºÅ\nÔºà„ÉÅ„É£„É¨„É≥„Ç∏Ôºö${totalCorrect}„Éî„Éº„ÇπÔºâ`
        : `„Éî„Éº„Çπ ${pieceNum} „ÇíÊâã„Å´ÂÖ•„Çå„ÅüÔºÅ\nÔºà„Éï„Ç°„Éü„É™„ÉºÔºö${totalCorrect}„Éî„Éº„ÇπÔºâ`;

      // Ëá™Âãï„ÅßÈÄ≤Êçó„Å∏
      setTimeout(() => {
        location.href = `progress.html?event=${encodeURIComponent(event)}&code=${encodeURIComponent(code)}&type=correct`;
      }, 850);
    }
  </script>
</body>
</html>

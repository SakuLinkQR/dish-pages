<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>QR„ÇØ„Ç®„Çπ„Éà - „Çπ„Ç≠„É£„Éä„Éº</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <style>
    body { font-family: sans-serif; background-color:#fefefe; text-align:center; padding:10px; margin:0; overflow-x:hidden; }
    h1 { color:#007bff; font-size:1.6rem; margin-bottom:12px; line-height:1.4; }
    #preview { width:300px; height:300px; border:1px solid #ccc; margin:20px auto; background:black; position:relative; border-radius:12px; overflow:hidden; }
    #preview video, #preview canvas { width:100% !important; height:100% !important; object-fit:cover; }
    #status, #result { margin:8px auto; max-width:520px; font-size:0.95rem; line-height:1.5; color:#444; word-break:break-all; }
    .btn { display:inline-block; margin:10px 6px; padding:12px 14px; border:none; border-radius:12px; background:#007bff; color:#fff; font-size:1rem; cursor:pointer; }
    .btn:disabled { opacity:.5; cursor:not-allowed; }
    .btn-exit { background:#6c757d; }
  </style>
  <script src="./lib/html5-qrcode.min.js">
    function stopScannerSafely(){
      try{
        if (window.__html5QrCodeInstance && window.__html5QrCodeInstance.isScanning) {
          return window.__html5QrCodeInstance.stop().catch(()=>{});
        }
        if (window.html5QrCode && window.html5QrCode.isScanning) {
          return window.html5QrCode.stop().catch(()=>{});
        }
      }catch(e){}
      return Promise.resolve();
    }
</script>
</head>
<body>
  <h1>QR„ÇØ„Ç®„Çπ„Éà - „Çπ„Ç≠„É£„Éä„Éº</h1>
  <div id="preview"></div>
  <div id="status">„Ç´„É°„É©„ÇíËµ∑Âãï‰∏≠‚Ä¶</div>
  <div id="result"></div>
  <div>
    <button id="btnRescan" class="btn">üîÑ ÂÜç„Çπ„Ç≠„É£„É≥</button>
    <button id="btnExit" class="btn btn-exit">üè† „É°„Éã„É•„Éº„Å´Êàª„Çã</button>
  </div>

<script>
  const params = new URLSearchParams(location.search);
  // return„ÅØ "start.html" „ÅÆ„Çà„ÅÜ„Å´Ê∏°„Åï„Çå„Çã„ÅÆ„Åß„ÄÅÂêåÈöéÂ±§„Å∏Êàª„Åô
  const mode = params.get('mode') || 'normal';
    // startkey „É¢„Éº„Éâ„Åß„ÅØ„ÄåÈñãÂßãÊ∏à„Åø„Äç„Çí„Çª„ÉÉ„Éà„Åô„Çã„Å†„Åë„Åß„ÄÅ„Éù„Ç§„É≥„ÉàÔºà„Éî„Éº„ÇπÔºâ„ÅÆËß£Êîæ„ÅØË°å„ÅÑ„Åæ„Åõ„Çì„ÄÇ
    const isStartKeyMode = (mode === 'startkey');
  const returnParam = params.get('return');
  const backParam = params.get('back');
  const returnTargetDefault = (mode === 'reward') ? '../reward_get.html' : '../start.html';
  const returnTarget = returnParam || returnTargetDefault;
  const backTarget = backParam || returnTarget;

  const html5QrCode = new Html5Qrcode("preview");
  const statusText = document.getElementById("status");
  const resultContainer = document.getElementById("result");
  const btnRescan = document.getElementById("btnRescan");
  const btnExit = document.getElementById("btnExit");

  let lastText = "";
  let lastAt = 0;
  let hasRedirected = false;
  let isScanning = false;

  function setButtonsEnabled(on){
    btnRescan.disabled = !on;
    btnExit.disabled = !on;
  }

  async function startScanner() {
    try {
      setButtonsEnabled(false);
      await html5QrCode.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: 250 },
        onScanSuccess,
        onScanFailure
      );
      isScanning = true;
      statusText.innerText = "„Ç´„É°„É©„ÅåËµ∑Âãï„Åó„Åæ„Åó„Åü„ÄÇQR„Ç≥„Éº„Éâ„Çí„Åã„Åñ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ";
      setButtonsEnabled(true);
    } catch (e) {
      isScanning = false;
      statusText.innerText = "„Ç´„É°„É©„ÅÆËµ∑Âãï„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ„Éñ„É©„Ç¶„Ç∂„ÅÆ„Ç´„É°„É©Ë®±ÂèØ„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ";
      resultContainer.innerText = String(e);
      setButtonsEnabled(true);
    }
  }

  async function stopScanner() {
    try { if (isScanning) { await html5QrCode.stop(); isScanning = false; } } catch(e){}
    try { await html5QrCode.clear(); } catch(e){}
  }

  function onScanFailure(_error) {}

  async function onScanSuccess(decodedText, _decodedResult) {
        // STARTKEY_ONLY: Âèó‰ªò„Çπ„Çø„Éº„ÉàQR„ÇíË™≠„Çì„Å†Â†¥Âêà„ÅØ„ÄÅÈñãÂßã„Éï„É©„Ç∞„Å†„Åë‰øùÂ≠ò„Åó„Å¶ÁµÇ‰∫ÜÔºà„Éî„Éº„ÇπËß£Êîæ„ÅØ„Åó„Å™„ÅÑÔºâ
        if (typeof isStartKeyMode !== 'undefined' && isStartKeyMode) {
          try {
            localStorage.setItem('started','true');
            localStorage.setItem('started_at', String(Date.now()));
          } catch(e) {}
          Promise.race([stopScannerSafely(), new Promise(r=>setTimeout(r,600))]).finally(() => {
            setTimeout(()=>{ window.location.replace(returnTarget); }, 120);
          });
          return;
        }

    const now = Date.now();
    if (decodedText === lastText && (now - lastAt) < 1200) return;
    lastText = decodedText;
    lastAt = now;
    resultContainer.innerText = decodedText;
    if (hasRedirected) return;
    hasRedirected = true;

    // reward„É¢„Éº„Éâ„Å™„Çâ„ÄÅÂèÇÂä†Ë≥ûÁî®QR„Å†„ÅëÈÄö„ÅôÔºà'reward'„ÇíÂê´„ÇÄÊÉ≥ÂÆöÔºâ
    if(mode === 'reward'){
      const ok = decodedText && (decodedText.includes('reward') || decodedText.includes('REWARD'));
      if(!ok){
        alert('ÂèÇÂä†Ë≥û„Ç≤„ÉÉ„ÉàÁî®QR„Åß„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ‰øÇÂì°„ÅÆQR„ÇíË™≠„ÅøËæº„Çì„Åß„Åè„Å†„Åï„ÅÑ„ÄÇ');
        hasRedirected = false;
        setTimeout(()=>rescan(), 100);
        return;
      }
      try{ localStorage.setItem('reward_scan_text', decodedText); }catch(e){}
    }

    await Promise.race([stopScanner(), new Promise(r=>setTimeout(r,600))]);
    try{
      localStorage.setItem("scan_text", decodedText);
      localStorage.setItem("last_scan_text", decodedText);
    }catch(e){}
    location.href = returnTarget;
  }

  async function rescan() {
    statusText.innerText = "ÂÜç„Çπ„Ç≠„É£„É≥Ê∫ñÂÇô‰∏≠‚Ä¶";
    await Promise.race([stopScanner(), new Promise(r=>setTimeout(r,600))]);
    hasRedirected = false;
    lastText = "";
    lastAt = 0;
    setTimeout(() => startScanner(), 150);
  }

  async function exitToMenu() {
      statusText.innerText = "„É°„Éã„É•„Éº„Å∏Êàª„Çä„Åæ„Åô‚Ä¶";
      setButtonsEnabled(false);
      await Promise.race([stopScanner(), new Promise(r=>setTimeout(r,600))]);
      await new Promise(r=>setTimeout(r,120));
      location.href = backTarget;
    }

  btnRescan.addEventListener('click', rescan);
  btnExit.addEventListener('click', exitToMenu);

  window.addEventListener("load", startScanner);
  window.addEventListener("pagehide", stopScanner);
  window.addEventListener("beforeunload", stopScanner);
</script>
</body>
</html>


<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>QRクエスト - スキャナー</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <style>
    body { font-family: sans-serif; background:#fefefe; text-align:center; padding:10px; margin:0; }
    h1 { color:#007bff; font-size:1.4rem; margin:12px 0; line-height:1.4; }
    #video { width: 92vw; max-width: 420px; border:1px solid #ccc; border-radius:12px; background:black; }
    .btn { display:inline-block; margin:10px 6px; padding:12px 14px; border:none; border-radius:12px; background:#007bff; color:#fff; font-size:1rem; cursor:pointer; }
    .btn:disabled { opacity:0.5; cursor:not-allowed; }
    #scanError { display:none; margin:10px auto; max-width:520px; padding:10px 12px; border:1px solid #f5c2c7; background:#fff5f5; border-radius:10px; font-size:0.95rem; line-height:1.5; }
    #hint { margin:8px auto 0; max-width:520px; color:#444; font-size:0.95rem; line-height:1.5; }
  </style>
</head>
<body>
  <h1>QRクエスト - スキャナー</h1>
  <div id="scanError"></div>
  <video id="video" playsinline></video>
  <div style="margin-top:6px;">
    <button id="btnRescan" class="btn" type="button">再SCAN</button>
    <button id="btnBackToMenu" class="btn" type="button">メニューに帰る</button>
  </div>
  <div id="hint">カメラが起動しない場合は、ブラウザのカメラ許可（許可/ブロック）を確認してください。</div>

<script>
(function(){
  const video = document.getElementById('video');
  const errBox = document.getElementById('scanError');
  const btnRescan = document.getElementById('btnRescan');
  const btnBack = document.getElementById('btnBackToMenu');

  let stream = null;
  let detector = null;
  let rafId = null;
  let scanning = false;

  function showError(msg){
    const text = (msg && (msg.message || msg.toString())) ? (msg.message || msg.toString()) : String(msg);
    errBox.textContent = text;
    errBox.style.display = 'block';
    console.warn(text);
  }
  function clearError(){
    errBox.textContent = '';
    errBox.style.display = 'none';
  }
  function setButtonsEnabled(on){
    btnRescan.disabled = !on;
    btnBack.disabled = !on;
  }

  async function stopCamera(){
    scanning = false;
    if(rafId){ cancelAnimationFrame(rafId); rafId = null; }
    if(stream){
      stream.getTracks().forEach(t => { try{ t.stop(); }catch(e){} });
      stream = null;
    }
    try{ video.srcObject = null; }catch(e){}
  }

  async function startCamera(){
    clearError();
    setButtonsEnabled(false);

    // BarcodeDetector availability
    if(!('BarcodeDetector' in window)){
      showError('このブラウザはQR読み取り（BarcodeDetector）に対応していません。別の端末/最新OSでお試しください。');
      return;
    }
    detector = new BarcodeDetector({ formats: ['qr_code'] });

    try{
      stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' }, audio:false });
      video.srcObject = stream;
      await video.play();
      scanning = true;
      setButtonsEnabled(true);
      tick();
    }catch(e){
      showError('カメラの起動に失敗しました。ブラウザのカメラ許可を確認してください。\n' + e);
      setButtonsEnabled(true);
    }
  }

  async function tick(){
    if(!scanning) return;
    try{
      const barcodes = await detector.detect(video);
      if(barcodes && barcodes.length){
        const text = barcodes[0].rawValue || '';
        if(text){
          // stop scanning quickly to avoid double fires
          await stopCamera();
          // Pass result to parent flow: use localStorage and redirect to handler page
          // We keep compatibility: store lastScanText and go to scan-handler.html if exists, else alert.
          try{
            localStorage.setItem('last_scan_text', text);
          }catch(e){}
          // If your project has a handler, use it. Otherwise just alert.
          if(location.href.indexOf('/scanner/') !== -1){
            // go back to start with param
            location.href = '../scan-result.html?text=' + encodeURIComponent(text);
          }else{
            alert(text);
          }
          return;
        }
      }
    }catch(e){
      // Detection errors are usually transient; show once and continue
      console.warn(e);
    }
    rafId = requestAnimationFrame(tick);
  }

  // Buttons
  btnRescan.addEventListener('click', async function(){
    // full restart: stop then start
    setButtonsEnabled(false);
    await stopCamera();
    setTimeout(()=>{ startCamera(); }, 150);
  });

  btnBack.addEventListener('click', async function(){
    setButtonsEnabled(false);
    await stopCamera();
    location.href = '../start.html';
  });

  window.addEventListener('pagehide', stopCamera);
  window.addEventListener('beforeunload', stopCamera);

  // Start on load
  window.addEventListener('load', startCamera);
})();
</script>
</body>
</html>

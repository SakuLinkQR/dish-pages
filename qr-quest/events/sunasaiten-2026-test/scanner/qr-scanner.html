<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>QRã‚¯ã‚¨ã‚¹ãƒˆ - ã‚¹ã‚­ãƒ£ãƒŠãƒ¼</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <style>
    body { font-family: sans-serif; background-color:#fefefe; text-align:center; padding:10px; margin:0; overflow-x:hidden; }
    h1 { color:#007bff; font-size:1.6rem; margin-bottom:12px; line-height:1.4; }
    #preview { width:300px; height:300px; border:1px solid #ccc; margin:20px auto; background:black; position:relative; border-radius:12px; overflow:hidden; }
    #preview video, #preview canvas { width:100% !important; height:100% !important; object-fit:cover; }
    #status, #result { margin:8px auto; max-width:520px; font-size:0.95rem; line-height:1.5; color:#444; word-break:break-all; }
    .btn { display:inline-block; margin:10px 6px; padding:12px 14px; border:none; border-radius:12px; background:#007bff; color:#fff; font-size:1rem; cursor:pointer; }
    .btn:disabled { opacity:.5; cursor:not-allowed; }
    .btn-exit { background:#6c757d; }
  </style>
  <script src="./lib/html5-qrcode.min.js"></script>
  <script src="../event-config.js"></script>
  <script>
    // èª­ã¿å–ã‚Šå®Œäº†å¾Œã€åœæ­¢å‡¦ç†ãŒè©°ã¾ã£ã¦ã‚‚é·ç§»ã§ãã‚‹ã‚ˆã†ã«å®‰å…¨åœæ­¢ãƒ˜ãƒ«ãƒ‘ãƒ¼ã‚’ç”¨æ„
    function stopScannerSafely(){
      try{
        if (window.__html5QrCodeInstance && window.__html5QrCodeInstance.isScanning) {
          return window.__html5QrCodeInstance.stop().catch(()=>{});
        }
      }catch(e){}
      return Promise.resolve();
    }
  </script>
</head>
<body>
  <h1>QRã‚¯ã‚¨ã‚¹ãƒˆ - ã‚¹ã‚­ãƒ£ãƒŠãƒ¼</h1>
  <div id="preview"></div>
  <div id="status">ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ä¸­â€¦</div>
  <div id="result"></div>
  <div>
    <button id="btnRescan" class="btn">ğŸ”„ å†ã‚¹ã‚­ãƒ£ãƒ³</button>
    <button id="btnExit" class="btn btn-exit">ğŸ  ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹</button>
  </div>

<script>
  const params = new URLSearchParams(location.search);
  // returnã¯ "start.html" ã®ã‚ˆã†ã«æ¸¡ã•ã‚Œã‚‹ã®ã§ã€åŒéšå±¤ã¸æˆ»ã™
  const mode = params.get('mode') || 'normal';
    // startkey ãƒ¢ãƒ¼ãƒ‰ã§ã¯ã€Œé–‹å§‹æ¸ˆã¿ã€ã‚’ã‚»ãƒƒãƒˆã™ã‚‹ã ã‘ã§ã€ãƒã‚¤ãƒ³ãƒˆï¼ˆãƒ”ãƒ¼ã‚¹ï¼‰ã®è§£æ”¾ã¯è¡Œã„ã¾ã›ã‚“ã€‚
    const isStartKeyMode = (mode === 'startkey');
  const returnParam = params.get('return');
  const backParam = params.get('back');
  const returnTargetDefault = (mode === 'reward') ? '../reward_get.html' : '../start.html';
  const returnTarget = returnParam || returnTargetDefault;
  const backTarget = backParam || returnTarget;

  const html5QrCode = new Html5Qrcode("preview");
  // stopScannerSafely() ç”¨ã«å…¬é–‹
  window.__html5QrCodeInstance = html5QrCode;
  const statusText = document.getElementById("status");
  const resultContainer = document.getElementById("result");
  const btnRescan = document.getElementById("btnRescan");
  const btnExit = document.getElementById("btnExit");

  let lastText = "";
  let lastAt = 0;
  let hasRedirected = false;
  let isScanning = false;

  function setButtonsEnabled(on){
    btnRescan.disabled = !on;
    btnExit.disabled = !on;
  }

  async function startScanner() {
    try {
      setButtonsEnabled(false);
      await html5QrCode.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: 250 },
        onScanSuccess,
        onScanFailure
      );
      isScanning = true;
      statusText.innerText = "ã‚«ãƒ¡ãƒ©ãŒèµ·å‹•ã—ã¾ã—ãŸã€‚QRã‚³ãƒ¼ãƒ‰ã‚’ã‹ã–ã—ã¦ãã ã•ã„ã€‚";
      setButtonsEnabled(true);
    } catch (e) {
      isScanning = false;
      statusText.innerText = "ã‚«ãƒ¡ãƒ©ã®èµ·å‹•ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚«ãƒ¡ãƒ©è¨±å¯ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚";
      resultContainer.innerText = String(e);
      setButtonsEnabled(true);
    }
  }

  async function stopScanner() {
    try { if (isScanning) { await html5QrCode.stop(); isScanning = false; } } catch(e){}
    try { await html5QrCode.clear(); } catch(e){}
  }

  function onScanFailure(_error) {}

  async function onScanSuccess(decodedText, _decodedResult) {
        // STARTKEY_ONLY: å—ä»˜ã‚¹ã‚¿ãƒ¼ãƒˆQRã¯ã€Œæ–‡å­—åˆ—ã‚’ä¿å­˜ â†’ å—ä»˜åˆ¤å®šãƒšãƒ¼ã‚¸ã¸é·ç§»ã€ã ã‘è¡Œã†ï¼ˆã“ã“ã§ã¯ started ã‚’ç«‹ã¦ãªã„ï¼‰
        if (typeof isStartKeyMode !== 'undefined' && isStartKeyMode) {
          const t = (decodedText || '').trim();
          const tl = t.toLowerCase();
          const looksLikeStart =
            tl.includes('start') ||
            tl.includes('shiyakusho') || tl.includes('cityhall') || tl.includes('å¸‚å½¹æ‰€') ||
            tl.includes('honmachi')   || tl.includes('æœ¬ç”º') ||
            tl.includes('fumoto')     || tl.includes('éº“');

          if(!looksLikeStart){
            alert('ã“ã‚Œã¯ã‚¹ã‚¿ãƒ¼ãƒˆQRã§ã¯ãªã„ã‚ˆã†ã§ã™ã€‚å—ä»˜ã§é…å¸ƒã•ã‚ŒãŸã‚¹ã‚¿ãƒ¼ãƒˆQRã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„ã€‚');
            // ã‚‚ã†ä¸€åº¦ã‚¹ã‚­ãƒ£ãƒ³ã§ãã‚‹ã‚ˆã†ã«æˆ»ã™
            hasRedirected = false;
            setTimeout(()=>rescan(), 120);
            return;
          }

          try {
            // start_after_key.html ã§åˆ¤å®šã«ä½¿ã†
            localStorage.setItem('start_scan_text', t);
            // âœ… startQRã¯ã€Œé€²è¡Œç”¨ã®scan_textã€ã«å…¥ã‚Œãªã„
            // ï¼ˆstart.htmlå´ã®åœ°ç‚¹QRåˆ¤å®šãŒèª¤ä½œå‹•ã—ã¦ã€ãƒ”ãƒ¼ã‚¹2ãªã©ãŒæœ€åˆã‹ã‚‰ä»˜ä¸ã•ã‚Œã‚‹ã®ã‚’é˜²ãï¼‰
            // äº’æ›ãŒå¿…è¦ãªã‚‰ start_scan_text ã‚’å‚ç…§ã™ã‚‹
          } catch(e) {}

          Promise.race([stopScannerSafely(), new Promise(r=>setTimeout(r,600))]).finally(() => {
            setTimeout(()=>{ window.location.replace(returnTarget); }, 120);
          });
          return;
        }

    const now = Date.now();
    if (decodedText === lastText && (now - lastAt) < 1200) return;
    lastText = decodedText;
    lastAt = now;
    resultContainer.innerText = decodedText;
    if (hasRedirected) return;
    hasRedirected = true;

    // rewardãƒ¢ãƒ¼ãƒ‰ãªã‚‰ã€å‚åŠ è³ç”¨QRã ã‘é€šã™ï¼ˆ'reward'ã‚’å«ã‚€æƒ³å®šï¼‰
    if(mode === 'reward'){
      const ok = decodedText && (decodedText.includes('reward') || decodedText.includes('REWARD'));
      if(!ok){
        alert('å‚åŠ è³ã‚²ãƒƒãƒˆç”¨QRã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ä¿‚å“¡ã®QRã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„ã€‚');
        hasRedirected = false;
        setTimeout(()=>rescan(), 100);
        return;
      }
      try{ localStorage.setItem('reward_scan_text', decodedText); }catch(e){}
    }

    await Promise.race([stopScanner(), new Promise(r=>setTimeout(r,600))]);
    try{
      localStorage.setItem("scan_text", decodedText);
      localStorage.setItem("last_scan_text", decodedText);
    }catch(e){}
    // å›éŠãƒ­ã‚°ï¼ˆã‚¹ã‚­ãƒ£ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆï¼‰
    try{
      if(window.QRQUEST_LOG){
        const short = (decodedText || '').toString().slice(0, 120);
        window.QRQUEST_LOG.send({
          page: "qr-scanner",
          area: "",
          qr_id: short,
          result: (mode === 'reward' ? "scan_reward" : "scan"),
          piece: "",
        });
      }
    }catch(e){}
    location.href = returnTarget;
  }

  async function rescan() {
    statusText.innerText = "å†ã‚¹ã‚­ãƒ£ãƒ³æº–å‚™ä¸­â€¦";
    await Promise.race([stopScanner(), new Promise(r=>setTimeout(r,600))]);
    hasRedirected = false;
    lastText = "";
    lastAt = 0;
    setTimeout(() => startScanner(), 150);
  }

  async function exitToMenu() {
      statusText.innerText = "ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¸æˆ»ã‚Šã¾ã™â€¦";
      setButtonsEnabled(false);
      await Promise.race([stopScanner(), new Promise(r=>setTimeout(r,600))]);
      await new Promise(r=>setTimeout(r,120));
      location.href = backTarget;
    }

  btnRescan.addEventListener('click', rescan);
  btnExit.addEventListener('click', exitToMenu);

  window.addEventListener("load", startScanner);
  // iOS(PWA) ã§ãƒ›ãƒ¼ãƒ ã‚¢ã‚¤ã‚³ãƒ³èµ·å‹•ãƒ»å¾©å¸°æ™‚ã« bfcache ã§çŠ¶æ…‹ãŒæ®‹ã‚Šã€é·ç§»ã—ãªã„äº‹ãŒã‚ã‚‹ãŸã‚å†åˆæœŸåŒ–
  window.addEventListener("pageshow", (ev)=>{
    if(ev && ev.persisted){
      hasRedirected = false; lastText = ""; lastAt = 0;
      setTimeout(()=>rescan(), 120);
    }
  });
  window.addEventListener("visibilitychange", ()=>{
    if(document.visibilityState === "visible" && !isScanning){
      // ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰å¾©å¸°ã§ã‚«ãƒ¡ãƒ©åœæ­¢ã—ã¦ã„ãŸå ´åˆ
      setTimeout(()=>startScanner(), 120);
    }
  });
  window.addEventListener("pagehide", stopScanner);
  window.addEventListener("beforeunload", stopScanner);
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="ja">
<head>
  <script src="../event-config.js"></script>
  <meta charset="UTF-8" />
  <title>QRクエスト - スキャナー</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    /* iPhoneでvhが暴れる対策 */
    :root { --vh: 1vh; }
    html, body { margin:0; padding:0; }

    body {
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", sans-serif;
      background-color: #fefefe;
      text-align: center;
      padding: 10px 12px 18px;
      overflow-x: hidden;
      min-height: calc(var(--vh) * 100);
      min-height: 100dvh;
      box-sizing: border-box;
      padding-bottom: env(safe-area-inset-bottom);
    }

    h1 {
      color: #007bff;
      font-size: 1.35rem;
      margin: 10px 0 10px;
      line-height: 1.4;
    }

    /* 固定300×300をやめる（縮み/崩れ対策） */
    #preview {
      width: min(86vw, 360px);
      aspect-ratio: 1 / 1;
      border: 1px solid #ccc;
      border-radius: 12px;
      margin: 14px auto 10px;
      background: #000;
      position: relative;
      overflow: hidden;
    }

    #preview video {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    #status {
      color: #666;
      font-size: 0.95rem;
      margin: 6px 0 2px;
    }

    #result {
      font-size: 1rem;
      color: #d32f2f;
      margin: 6px 0 12px;
      min-height: 1.2em;
      padding: 0 10px;
      word-break: break-word;
      white-space: pre-wrap;
    }

    .btn {
      margin: 6px;
      padding: 10px 18px;
      background-color: #4caf50;
      color: #fff;
      border: none;
      border-radius: 10px;
      font-size: 1rem;
      cursor: pointer;
      min-width: 140px;
    }

    .btn-exit { background-color: #ff7043; }
  </style>

  

<script>window.addEventListener('load', startScan);</script>

<script>
(function(){
  // ---- State ----
  let qr = null;
  let scanning = false;

  // ---- UI helpers ----
  function $(id){ return document.getElementById(id); }
  function showError(msg){
    const el = $('scanError');
    const text = (msg && (msg.message || msg.toString())) ? (msg.message || msg.toString()) : String(msg);
    if(el){ el.textContent = text; el.style.display='block'; }
    console.warn(text);
  }
  function setButtonsEnabled(on){
    const b1 = $('btnRescan');
    const b2 = $('btnBackToMenu');
    if(b1) b1.disabled = !on;
    if(b2) b2.disabled = !on;
  }

  // ---- Scan callbacks ----
  window.onScanSuccess = window.onScanSuccess || function(decodedText){
    try{
      // existing handler may be defined elsewhere; if so, call it
      if(window.__onScanSuccessOriginal){ return window.__onScanSuccessOriginal(decodedText); }
    }catch(e){}
    // fallback: just show decoded text
    alert(decodedText);
  };
  window.onScanFailure = window.onScanFailure || function(_err){};

  async function ensureInstance(){
    if(qr) return true;
    // Library check
    if(typeof Html5Qrcode === 'undefined'){
      showError('スキャナーライブラリの読み込みに失敗しました。通信環境を確認して、再読み込みしてください。');
      return false;
    }
    const reader = $('reader');
    if(!reader){
      showError('reader要素が見つかりません（HTMLのID不整合）');
      return false;
    }
    qr = new Html5Qrcode('reader');
    // expose for debugging / old code compatibility
    window.html5QrCode = qr;
    return true;
  }

  async function start(){
    const ok = await ensureInstance();
    if(!ok) return;
    if(scanning) return;
    try{
      scanning = true;
      const config = { fps: 10, qrbox: 250 };
      await qr.start({ facingMode: "environment" }, config, window.onScanSuccess, window.onScanFailure);
      setButtonsEnabled(true);
    }catch(e){
      scanning = false;
      showError(e);
      setButtonsEnabled(true);
    }
  }

  async function stop(){
    if(!qr || !scanning) return;
    try{
      await qr.stop();
    }catch(e){
      // ignore stop error
      console.warn(e);
    }finally{
      scanning = false;
      try{ await qr.clear(); }catch(e){ /* ignore */ }
    }
  }

  // Public buttons
  window.safeRescan = async function(){
    // Prevent "can't clear while scan is ongoing"
    setButtonsEnabled(false);
    await stop();
    // Small delay for stability
    setTimeout(()=>{ start(); }, 150);
  };

  window.backToMenu = async function(){
    setButtonsEnabled(false);
    await stop();
    location.href = '../start.html';
  };

  // init on load
  window.addEventListener('load', function(){
    // Ensure error div exists
    if(!$('scanError')){
      const box = document.createElement('div');
      box.id = 'scanError';
      box.style.cssText = 'display:none;margin:10px auto;max-width:520px;padding:10px 12px;border:1px solid #f5c2c7;background:#fff5f5;border-radius:10px;font-size:0.95rem;line-height:1.5;';
      const h1 = document.querySelector('h1');
      if(h1 && h1.parentNode){ h1.parentNode.insertBefore(box, h1.nextSibling); }
      else { document.body.insertBefore(box, document.body.firstChild); }
    }
    setButtonsEnabled(false);
    start();
  });
})();
</script>

</body>
</html>
<!DOCTYPE html>
<html lang="ja">
<head>
  <script src="../event-config.js"></script>
  <meta charset="UTF-8" />
  <title>QRã‚¯ã‚¨ã‚¹ãƒˆ - ã‚¹ã‚­ãƒ£ãƒŠãƒ¼</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    /* iPhoneã§vhãŒæš´ã‚Œã‚‹å¯¾ç­– */
    :root { --vh: 1vh; }
    html, body { margin:0; padding:0; }

    body {
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", sans-serif;
      background-color: #fefefe;
      text-align: center;
      padding: 10px 12px 18px;
      overflow-x: hidden;
      min-height: calc(var(--vh) * 100);
      min-height: 100dvh;
      box-sizing: border-box;
      padding-bottom: env(safe-area-inset-bottom);
    }

    h1 {
      color: #007bff;
      font-size: 1.35rem;
      margin: 10px 0 10px;
      line-height: 1.4;
    }

    /* å›ºå®š300Ã—300ã‚’ã‚„ã‚ã‚‹ï¼ˆç¸®ã¿/å´©ã‚Œå¯¾ç­–ï¼‰ */
    #preview {
      width: min(86vw, 360px);
      aspect-ratio: 1 / 1;
      border: 1px solid #ccc;
      border-radius: 12px;
      margin: 14px auto 10px;
      background: #000;
      position: relative;
      overflow: hidden;
    }

    #preview video {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    #status {
      color: #666;
      font-size: 0.95rem;
      margin: 6px 0 2px;
    }

    #result {
      font-size: 1rem;
      color: #d32f2f;
      margin: 6px 0 12px;
      min-height: 1.2em;
      padding: 0 10px;
      word-break: break-word;
      white-space: pre-wrap;
    }

    .btn {
      margin: 6px;
      padding: 10px 18px;
      background-color: #4caf50;
      color: #fff;
      border: none;
      border-radius: 10px;
      font-size: 1rem;
      cursor: pointer;
      min-width: 140px;
    }

    .btn-exit { background-color: #ff7043; }
  </style>

  <script>
    function setVh(){
      document.documentElement.style.setProperty('--vh', (window.innerHeight * 0.01) + 'px');
    }
    setVh();
    window.addEventListener('resize', setVh);
  </script>

  <script>
  (function(){
    const lang = localStorage.getItem("lang") || "";
    const reg  = localStorage.getItem("app_registered") === "true";
    const viewOnly = localStorage.getItem("view_only") === "true";
    const mode = localStorage.getItem("mode") || "info";
    if(!lang){ location.replace("../language.html"); return; }
    // ã€Œé–²è¦§ãƒ¢ãƒ¼ãƒ‰ã€ã¯ infoï¼ˆç ‚åƒè§£èª¬ï¼‰ã‚¹ã‚­ãƒ£ãƒ³ã ã‘è¨±å¯
    if(!reg){
      if (viewOnly && mode === "info") return;
      location.replace(viewOnly ? "../register.html" : "../mode_select.html");
      return;
    }
  })();
  </script>

</head>

<body>
  <h1 id="title">ğŸ¯ QRã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿å–ã£ã¦<br>ã‚¯ã‚¨ã‚¹ãƒˆã‚’é€²ã‚ã‚ˆã†</h1>

  <div id="preview"></div>
  <p id="status">ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ä¸­â€¦</p>
  <div id="result"></div>

  <button onclick="rescan()" class="btn">ğŸ”„ å†ã‚¹ã‚­ãƒ£ãƒ³</button>
  <button onclick="exitToMenu()" class="btn btn-exit" id="exitBtn">ğŸ  ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹</button>

  <!-- html5-qrcode æœ¬ä½“ -->
  <script src="https://unpkg.com/html5-qrcode"></script>

  <script>
    // mode=test ã®ã¨ãã¯ã€Œãƒ†ã‚¹ãƒˆç”¨æŒ™å‹•ã€ã«ã™ã‚‹
    const params = new URLSearchParams(location.search);
    const mode = params.get("mode"); // "test" or null

    const titleEl = document.getElementById("title");
    const exitBtn = document.getElementById("exitBtn");

    if (mode === "test") {
      titleEl.innerHTML = "ğŸ“· ã‚«ãƒ¡ãƒ©ãƒ†ã‚¹ãƒˆ<br>QRã‚’1ã¤èª­ã¿å–ã£ã¦ã¿ã¦ãã ã•ã„";
      exitBtn.textContent = "â†© ãƒ†ã‚¹ãƒˆç”»é¢ã«æˆ»ã‚‹";
    }

    const html5QrCode = new Html5Qrcode("preview");
    const statusText = document.getElementById("status");
    const resultContainer = document.getElementById("result");

    // åŒä¸€ã‚³ãƒ¼ãƒ‰ã®é€£ç¶šåˆ¤å®šã‚’æŠ‘åˆ¶ã™ã‚‹ãŸã‚ã®ãƒ‡ãƒã‚¦ãƒ³ã‚¹
    let lastText = "";
    let lastAt = 0;

    // é·ç§»æ™‚ã®å¤šé‡ã‚¹ã‚¿ãƒ¼ãƒˆé˜²æ­¢ãƒ•ãƒ©ã‚°
    let hasRedirected = false;

    // ã‚«ãƒ¡ãƒ©é–‹å§‹
    async function startScanner() {
      try {
        await html5QrCode.start(
          { facingMode: "environment" },
          { fps: 10, qrbox: 250 },
          onScanSuccess,
          onScanFailure
        );
        statusText.innerText = "ã‚«ãƒ¡ãƒ©ãŒèµ·å‹•ã—ã¾ã—ãŸã€‚QRã‚³ãƒ¼ãƒ‰ã‚’ã‹ã–ã—ã¦ãã ã•ã„ã€‚";
      } catch (err) {
        statusText.innerText = "ã‚«ãƒ¡ãƒ©ã‚¨ãƒ©ãƒ¼ï¼š" + err;
      }
    }

    // ã‚«ãƒ¡ãƒ©åœæ­¢
    async function stopScanner() {
      try {
        if (html5QrCode._isScanning) {
          await html5QrCode.stop();
        }
      } catch (_) {
        // å¤±æ•—ã¯æ¡ã‚Šã¤ã¶ã—
      } finally {
        document.getElementById("preview").innerHTML = "";
      }
    }

    // ã‚¹ã‚­ãƒ£ãƒ³æˆåŠŸæ™‚
    function onScanSuccess(decodedText) {
      if (hasRedirected) return;

      // åŒä¸€å†…å®¹ã®é€£ç¶šãƒ’ãƒƒãƒˆã¯1.5ç§’ç„¡è¦–
      const now = Date.now();
      if (decodedText === lastText && now - lastAt < 1500) return;
      lastText = decodedText;
      lastAt = now;

      // â–¼ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ï¼šèª­ã¿å–ã‚ŒãŸã‚‰OKè¡¨ç¤ºã—ã¦åœæ­¢ï¼ˆã©ã“ã«ã‚‚é£›ã°ãªã„ï¼‰
      if (mode === "test") {
        resultContainer.innerText = "âœ… èª­ã¿å–ã‚ŠæˆåŠŸï¼\n" + decodedText;
        statusText.innerText = "ãƒ†ã‚¹ãƒˆOKã§ã™ã€‚æˆ»ã‚‹ãƒœã‚¿ãƒ³ã§æˆ»ã£ã¦ãã ã•ã„ã€‚";
        navigator.vibrate?.(60);
        stopScanner();
        return;
      }

      // ==============================
      // QRã‚¯ã‚¨ã‚¹ãƒˆï¼šã‚³ãƒ¼ãƒ‰æ–‡å­—åˆ—ã‚’å‡¦ç†ã™ã‚‹ï¼ˆURLã§ã¯ãªãã‚³ãƒ¼ãƒ‰æ¨å¥¨ï¼‰
      // ==============================
      const code = (decodedText || "").trim();

      // â–¼ã“ã“ã§ã‚¤ãƒ™ãƒ³ãƒˆç”¨ã®ã‚³ãƒ¼ãƒ‰å®šç¾©ï¼ˆå¿…è¦ãªã‚‰å¾Œã§å·®ã—æ›¿ãˆï¼‰
      const START_CODES = {
        "SS26-START-SHIYAKUSHO": "shiyakusho",
        "SS26-START-HONMACHI": "honmachi",
        "SS26-START-FUMOTO": "fumoto"
      };

      // 7ãƒã‚¤ãƒ³ãƒˆï¼ˆ=æ®‹ã‚Š7ãƒ”ãƒ¼ã‚¹ï¼‰
      const POINT_CODES = {
        "SS26-P-SHIYAKUSHO": { area: "shiyakusho", piece: 2 },
        "SS26-P-HONMACHI-1": { area: "honmachi", piece: 3 },
        "SS26-P-HONMACHI-2": { area: "honmachi", piece: 4 },
        "SS26-P-FUMOTO-1": { area: "fumoto", piece: 6 },
        "SS26-P-FUMOTO-2": { area: "fumoto", piece: 7 },
        "SS26-P-FUMOTO-3": { area: "fumoto", piece: 8 },
        "SS26-P-FUMOTO-4": { area: "fumoto", piece: 9 }
      };

      // å‚åŠ è³äº¤ä»˜ï¼ˆä¿‚å“¡ç”¨ï¼‰
      const STAFF_REWARD_CODE = "SS26-STAFF-REWARD";

      // 9åˆ†å‰²ï¼ˆå—ä»˜ã§2æšã‚ªãƒ¼ãƒ—ãƒ³ï¼‰
      const OPEN_ON_START = [1, 5]; // â†å¿…è¦ãªã‚‰å¤‰æ›´ï¼ˆä¸­å¤®+è§’ãŒã‚ã‹ã‚Šã‚„ã™ã„ï¼‰

      // helper
      const setPiece = (n) => localStorage.setItem(`q_piece${n}`, "true");
      const isStarted = () => localStorage.getItem("started") === "true";
      const setAreaCleared = (area) => {
        if (area === "shiyakusho") localStorage.setItem("area_shiyakusho", "true");
        if (area === "honmachi")   localStorage.setItem("area_honmachi", "true");
        if (area === "fumoto")     localStorage.setItem("area_fumoto", "true");
      };
      const isRewardEligible = () => (
        localStorage.getItem("area_shiyakusho") === "true" &&
        localStorage.getItem("area_honmachi") === "true" &&
        localStorage.getItem("area_fumoto") === "true"
      );

      // â–¼ã‚¹ã‚¿ãƒ¼ãƒˆã‚­ãƒ¼
      if (START_CODES[code]) {
        const area = START_CODES[code];

        // æ—¢ã«é–‹å§‹æ¸ˆã¿ã§ã‚‚ã€Œé–‹å§‹å—ä»˜ã‚¨ãƒªã‚¢ã€ã‚’æ›´æ–°ï¼ˆç¾å ´é‹ç”¨å‘ã‘ï¼‰
        localStorage.setItem("started", "true");
        localStorage.setItem("start_area", area);

        // å—ä»˜ã§2ãƒ”ãƒ¼ã‚¹ã‚’è‡ªå‹•ã‚ªãƒ¼ãƒ—ãƒ³
        for (const n of OPEN_ON_START) setPiece(n);

        navigator.vibrate?.(60);
        hasRedirected = true;
        stopScanner().finally(() => {
          // ã‚¢ãƒ—ãƒªè¨­å®šï¼ˆregisterï¼‰â†’ãƒ›ãƒ¼ãƒ ã¸
          const registered = (localStorage.getItem("app_registered") === "true");
          if (!registered) {
            window.location.href = "../register.html";
          } else {
            window.location.href = "../index.html";
          }
        });
        return;
      }

      // â–¼å‚åŠ è³äº¤ä»˜ï¼ˆä¿‚å“¡ç”¨ï¼‰
      if (code === STAFF_REWARD_CODE) {
        if (!isStarted()) {
          resultContainer.innerText = "ã¾ã å—ä»˜ã§ã‚¹ã‚¿ãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“ã€‚";
          statusText.innerText = "å—ä»˜ã§ã‚¹ã‚¿ãƒ¼ãƒˆã‚­ãƒ¼ã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„ã€‚";
          navigator.vibrate?.(80);
          return;
        }
        const claimed = (localStorage.getItem("reward_claimed") === "true");
        if (claimed) {
          resultContainer.innerText = "å‚åŠ è³ã¯ã™ã§ã«å—ã‘å–ã‚Šæ¸ˆã¿ã§ã™ã€‚";
          statusText.innerText = "ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸã€‚";
          navigator.vibrate?.(60);
          return;
        }
        if (!isRewardEligible()) {
          resultContainer.innerText = "æ¡ä»¶æœªé”ã®ãŸã‚ã€ã¾ã äº¤ä»˜ã§ãã¾ã›ã‚“ã€‚";
          statusText.innerText = "å„ã‚¨ãƒªã‚¢ã®ãƒã‚¤ãƒ³ãƒˆã‚’æœ€ä½1ã¤ãšã¤è¦‹ã¤ã‘ã¦ãã ã•ã„ã€‚";
          navigator.vibrate?.(80);
          return;
        }

        localStorage.setItem("reward_claimed", "true");
        localStorage.setItem("reward_claimed_at", String(Date.now()));
        navigator.vibrate?.(120);

        hasRedirected = true;
        stopScanner().finally(() => {
          window.location.href = "../start.html";
        });
        return;
      }

      // â–¼ãƒã‚¤ãƒ³ãƒˆï¼ˆ7ç®‡æ‰€ï¼‰
      if (POINT_CODES[code]) {
        if (!isStarted()) {
          hasRedirected = true;
          stopScanner().finally(() => {
            window.location.href = "../need_start.html";
          });
          return;
        }

        const info = POINT_CODES[code];
        setPiece(info.piece);
        setAreaCleared(info.area);

        navigator.vibrate?.(60);

        hasRedirected = true;
        stopScanner().finally(() => {
          window.location.href = "../progress.html";
        });
        return;
      }

      // â–¼URLï¼ˆå¤ã„QRãªã©ï¼‰ã‚’èª­ã¿å–ã£ãŸå ´åˆã¯ã€Œå…¬å¼ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€
      if (code.startsWith("http")) {
        resultContainer.innerText = "ã“ã®QRã¯ç¾åœ¨ã®QRã‚¯ã‚¨ã‚¹ãƒˆã§ã¯ä½¿ç”¨ã§ãã¾ã›ã‚“ã€‚";
        statusText.innerText = "å—ä»˜ã¾ãŸã¯ãƒã‚¤ãƒ³ãƒˆã®QRã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„ã€‚";
        navigator.vibrate?.(80);
        return;
      }

      // â–¼ä¸æ˜ã‚³ãƒ¼ãƒ‰
      resultContainer.innerText = "ç„¡åŠ¹ãªQRã‚³ãƒ¼ãƒ‰ã§ã™ã€‚";
      statusText.innerText = "ã‚‚ã†ä¸€åº¦ã‹ã–ã—ã¦ãã ã•ã„ã€‚";
      navigator.vibrate?.(80);
      return;

    // ã‚¹ã‚­ãƒ£ãƒ³å¤±æ•—æ™‚ï¼ˆãƒ•ãƒ¬ãƒ¼ãƒ æ¯ã®å¤±æ•—é€šçŸ¥ã€‚ä½•ã‚‚ã—ãªã„ï¼‰
    function onScanFailure(_) { /* no-op */ }

    // å†ã‚¹ã‚­ãƒ£ãƒ³
    async function rescan() {
      hasRedirected = false;
      resultContainer.innerText = "";
      statusText.innerText = "å†ã‚¹ã‚­ãƒ£ãƒ³ã‚’æº–å‚™ä¸­â€¦";
      await stopScanner();
      setTimeout(startScanner, 300);
    }

    // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹
    async function exitToMenu() {
      await stopScanner();
      if (mode === "test") {
        window.location.href = "../test-camera.html";
        return;
      }

      // return=xxx ãŒã‚ã‚Œã°ãã“ã¸æˆ»ã‚‹ï¼ˆä¾‹ï¼šreturn=start.htmlï¼‰
      const ret = params.get("return");
      if (ret) {
        window.location.href = ret.startsWith("../") ? ret : ("../" + ret);
        return;
      }

      // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯QRã‚¯ã‚¨ã‚¹ãƒˆã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¸
      window.location.href = "../start.html";
    }

// ãƒšãƒ¼ã‚¸å¯è¦–çŠ¶æ…‹ã®å¤‰åŒ–ã§å†èµ·å‹•ï¼ˆå¾©å¸°æ™‚ã«å›ºã¾ã‚‹å¯¾ç­–ï¼‰
    document.addEventListener("visibilitychange", () => {
      if (document.visibilityState === "visible" && !hasRedirected) {
        startScanner();
      }
    });

    // ãƒšãƒ¼ã‚¸é·ç§»/ç ´æ£„æ™‚ã¯æ˜ç¤ºåœæ­¢
    window.addEventListener("pagehide", stopScanner);
    window.addEventListener("beforeunload", stopScanner);

    // åˆå›èµ·å‹•
    startScanner();
  </script>
</body>
</html>
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>QRã‚¯ã‚¨ã‚¹ãƒˆ - çµæœç”»é¢</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- ====== ç°¡æ˜“ã‚¹ã‚¿ã‚¤ãƒ« ====== -->
  <style>
    :root {
      --bg: #fff8ec;
      --ink: #444;
      --accent: #ff6f00;
    }
    body {
      margin: 0; padding: 24px 16px;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Hiragino Kaku Gothic ProN", "Noto Sans JP", sans-serif;
      background: var(--bg); color: var(--ink); text-align: center;
    }
    h1 { margin: 0 0 8px; font-size: 1.6rem; color: var(--accent); }
    #message { margin: 12px auto 10px; font-size: 1.15rem; line-height: 1.6; min-height: 2.2em; }
    #resultImg { display:none; width: 66vw; max-width: 260px; height: auto; margin: 10px auto 0; border-radius: 12px; }
    .btns { margin-top: 20px; display: grid; gap: 10px; justify-content: center; }
    .btn {
      display: inline-block; padding: 12px 18px; border-radius: 999px;
      background: #4caf50; color: #fff; text-decoration: none; font-weight: 600;
      box-shadow: 0 6px 16px rgba(76,175,80,.25);
    }
    .btn.secondary { background:#2196f3; box-shadow: 0 6px 16px rgba(33,150,243,.25); }

    /* ====== æ‰‰ï¼†è”¦ï¼†å…‰ã®ç°¡æ˜“æ¼”å‡ºï¼ˆä»»æ„ï¼‰ ====== */
    #reveal-scene {
      position: fixed; inset: 0; display:none; justify-content:center; align-items:center; background:#000;
      z-index: 9999;
    }
    #reveal-scene .stage { position:relative; width: 82vw; max-width: 420px; aspect-ratio: 3/4; overflow:hidden; }
    #reveal-scene .layer { position:absolute; inset:0; width:100%; height:100%; object-fit:cover; opacity:0; }
    #reveal-scene .door  { animation: doorFade 900ms ease forwards; }
    #reveal-scene .vines { animation: vinesFade 900ms ease 120ms forwards; }
    #reveal-scene .light { animation: lightRise 1100ms ease 220ms forwards; mix-blend-mode:screen; }
    @keyframes doorFade  { from{opacity:0; transform:scale(1.05)} to{opacity:1; transform:scale(1)} }
    @keyframes vinesFade { from{opacity:0} to{opacity:.92} }
    @keyframes lightRise { 0%{opacity:0; transform:scale(1) translateY(10%)} 60%{opacity:1} 100%{opacity:1; transform:scale(1.07) translateY(-3%)} }
    .reveal-out { animation: sceneOut 360ms ease forwards; }
    @keyframes sceneOut { to { opacity:0; visibility:hidden } }

    /* ä½ãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®šã®ç«¯æœ«ã§ã¯æ¼”å‡ºOFF */
    @media (prefers-reduced-motion: reduce) {
      #reveal-scene { display:none !important; }
    }
  </style>
</head>
<body>
  <h1>ç™ºè¦‹çµæœ</h1>
  <p id="message">åˆ¤å®šä¸­â€¦</p>
  <img id="resultImg" alt="result" />

  <!-- ä»»æ„ï¼šãƒœã‚¿ãƒ³ï¼ˆå¿…è¦ãªã‚‰ãƒªãƒ³ã‚¯å…ˆã‚’èª¿æ•´ï¼‰ -->
  <div class="btns">
    <a class="btn" href="progress.html">é€²è¡ŒçŠ¶æ³ã‚’è¦‹ã‚‹</a>
    <a class="btn secondary" href="index.html">ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¸æˆ»ã‚‹</a>
  </div>

  <!-- æ‰‰ãƒ»è”¦ãƒ»å…‰ã®æ¼”å‡ºãƒ¬ã‚¤ãƒ¤ãƒ¼ï¼ˆç”»åƒã¯ä»»æ„å·®ã—æ›¿ãˆï¼‰ -->
  <div id="reveal-scene" aria-hidden="true">
    <div class="stage">
      <img class="layer door"  src="images/door.png"  alt="">
      <img class="layer vines" src="images/vines.png" alt="">
      <img class="layer light" src="images/light.png" alt="">
    </div>
  </div>

  <script>
  /********************
   * è¨­å®šï¼ˆç’°å¢ƒã«åˆã‚ã›ã¦èª¿æ•´ï¼‰
   ********************/
  const CSV_URL = "/qr-quest/data/messages.csv"; // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‹ã‚‰æ›¸ãå‡ºã—ãŸCSVã®è¨­ç½®å ´æ‰€
  const IMG_DIR = "/images/duds/";               // ãƒ€ãƒŸãƒ¼ç”»åƒãƒ•ã‚©ãƒ«ãƒ€
  const IMG_EXT = ".png";                        // æ‹¡å¼µå­ï¼ˆ.webpç­‰ã«å¤‰æ›´å¯ï¼‰
  const PIECE_KEYS = { "001":"piece1","002":"piece2","003":"piece3","004":"piece4" }; // æ­£è§£ãƒ”ãƒ¼ã‚¹ã®ä¾‹

  /********************
   * ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
   ********************/
  function qs(sel){ return document.querySelector(sel); }
  function getParam(name){ return new URLSearchParams(location.search).get(name); }
  const wait = (ms)=>new Promise(r=>setTimeout(r,ms));

  // CSVã®1è¡Œã‚’"â€¦"å¯¾å¿œã§åˆ†å‰²
  function splitCsvLine(line){
    const out=[]; let cur="", inQ=false;
    for(let i=0;i<line.length;i++){
      const ch=line[i];
      if(ch === '"'){
        if(inQ && line[i+1] === '"'){ cur+='"'; i++; } else inQ = !inQ;
      } else if(ch === ',' && !inQ){
        out.push(cur); cur="";
      } else {
        cur += ch;
      }
    }
    out.push(cur);
    return out;
  }

  // CSV â†’ é…åˆ—{code,name,category,msg,file}
  let __rowsCache=null;
  async function loadRows(){
    if(__rowsCache) return __rowsCache;
    const text = await fetch(CSV_URL, {cache:"no-store"}).then(r=>r.text());
    const lines = text.trim().split(/\r?\n/);
    const header = splitCsvLine(lines.shift());
    const idx = {
      code: header.indexOf("code"),
      name: header.indexOf("name"),
      category: header.indexOf("category"),
      msg: header.indexOf("msg")
    };
    const rows=[];
    for(const line of lines){
      if(!line.trim()) continue;
      const c = splitCsvLine(line);
      const code = (c[idx.code]||"").trim();
      const name = (c[idx.name]||"").trim();
      const category = (c[idx.category]||"").trim();
      const msg = (c[idx.msg]||"").trim();
      if(!code || !name || !msg) continue;
      rows.push({ code, name, category, msg, file: `${name}_${code}${IMG_EXT}` });
    }
    __rowsCache = rows;
    return rows;
  }

  const pick = arr => arr[Math.floor(Math.random()*arr.length)];

  async function imageExists(path){
    try{
      const r = await fetch(path, {method:"HEAD"});
      return r.ok;
    }catch(e){ return false; }
  }

  /********************
   * æ‰‰ï¼†è”¦ã®ç°¡æ˜“æ¼”å‡º
   ********************/
  async function playRevealScene(duration=1200){
    const scene = qs('#reveal-scene');
    if(!scene) return;
    scene.style.display = 'flex';
    // ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆç¢ºå®šã®ãŸã‚reflow
    void scene.offsetWidth;
    await wait(duration);
    scene.classList.add('reveal-out');
    await wait(360);
    scene.style.display = 'none';
    scene.classList.remove('reveal-out');
  }

  /********************
   * æ­£è§£è¡¨ç¤ºï¼ˆãƒ”ãƒ¼ã‚¹ï¼‰
   ********************/
  function pieceKeyFromId(qrId){
    return PIECE_KEYS[qrId] || null;
  }

  function showCorrectPiece(id){
    const key = pieceKeyFromId(id);
    const msgEl = qs('#message');
    const imgEl = qs('#resultImg');

    if(!key){
      msgEl.innerText = "â“ ä¸æ˜ãªQRã‚³ãƒ¼ãƒ‰ã§ã™ã€‚";
      return;
    }
    const isDup = localStorage.getItem(key) === "true";
    if(isDup){
      msgEl.innerText = "ğŸ‘€ ã•ã£ãè¦‹ã¤ã‘ãŸã°ã‹ã‚Šã˜ã‚ƒï¼ ã¤ãã¸é€²ã‚‚ã†ã€‚";
    } else {
      localStorage.setItem(key, "true");
      msgEl.innerText = "ğŸ‰ ãƒ”ãƒ¼ã‚¹ã‚’ã‚²ãƒƒãƒˆï¼";
    }
    // ä¾‹ï¼šimages/piece1.png ç­‰ï¼ˆå¿…è¦ã«å¿œã˜ã¦ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆã‚’åˆã‚ã›ã¦ãã ã•ã„ï¼‰
    const num = key.replace("piece","");
    imgEl.src = `images/piece${num}.png`;
    imgEl.style.display = "block";
  }

  /********************
   * ãƒ€ãƒŸãƒ¼è¡¨ç¤ºï¼ˆCSV â†’ PNGåã‚’çµ„ã¿ç«‹ã¦ï¼‰
   ********************/
  async function showDummyFromCsv() {
    const msgEl = qs("#message");
    const imgEl = qs("#resultImg");

    const rows = await loadRows();
    if(!rows.length){
      msgEl.innerText = "ï¼ˆãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ï¼‰";
      return;
    }

    // ç›´å‰é‡è¤‡ã‚’é¿ã‘ã¤ã¤å­˜åœ¨ã™ã‚‹ç”»åƒã‚’é¸ã¶ï¼ˆæœ€å¤§5å›å¼•ãç›´ã—ï¼‰
    const last = sessionStorage.getItem("lastDummyFile");
    let chosen = null, tries = 5;
    while(tries-- > 0){
      const candidate = pick(rows);
      const filePath = IMG_DIR + candidate.file;
      if(last === candidate.file) continue;
      if(await imageExists(filePath)){ chosen = candidate; break; }
    }
    if(!chosen) chosen = pick(rows);

    msgEl.innerText = chosen.msg;
    imgEl.src = IMG_DIR + chosen.file;
    imgEl.style.display = "block";
    sessionStorage.setItem("lastDummyFile", chosen.file);
  }

  /********************
   * ãƒ¡ã‚¤ãƒ³ãƒ•ãƒ­ãƒ¼
   * URLã®ä¾‹:
   *   result.html?id=001  â†’ æ­£è§£ï¼ˆpiece1ï¼‰
   *   result.html?id=999  â†’ ãƒ€ãƒŸãƒ¼ï¼ˆä¸æ­£è§£ï¼‰
   ********************/
  (async function main(){
    const id = getParam("id"); // ä¾‹ï¼š001, 002, ...
    const isCorrect = !!pieceKeyFromId(id); // idãŒå®šç¾©ã•ã‚Œã¦ã„ã‚Œã°æ­£è§£ã€ãã‚Œä»¥å¤–ã¯ãƒ€ãƒŸãƒ¼ã¨ã„ã†ã‚·ãƒ³ãƒ—ãƒ«åˆ¤å®šï¼ˆå¿…è¦ã«å¿œã˜ã¦èª¿æ•´ï¼‰

    // ä»»æ„ã®æ¼”å‡º
    await playRevealScene(1200);

    if(isCorrect){
      showCorrectPiece(id);
    }else{
      await showDummyFromCsv();
    }
  })();
  </script>
</body>
</html>
